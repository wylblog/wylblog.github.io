<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="ClickHouse单机部署配置使用(21.9.4.35), 無以菱">
    <meta name="description" content="ClickHouse官网：https://clickhouse.com/
官方文档：https://clickhouse.com/docs/en/intro
tgz包下载：https://packages.clickhouse.com/tg">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>ClickHouse单机部署配置使用(21.9.4.35) | 無以菱</title>
    <link rel="icon" type="image/png" href="https://img.picui.cn/free/2024/11/10/67306caab06fb.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    
        <link rel="stylesheet" type="text/css" href="/css/reward.css">
    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 5.4.2"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="https://img.picui.cn/free/2024/11/13/673439e447e45.jpg" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">無以菱</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友链</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="https://img.picui.cn/free/2024/11/13/673439e447e45.jpg" class="logo-img circle responsive-img">
        
        <div class="logo-name">無以菱</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友链
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/8.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">ClickHouse单机部署配置使用(21.9.4.35)</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Bigdata/">
                                <span class="chip bg-color">Bigdata</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE%E8%BF%90%E7%BB%B4%E7%B3%BB%E5%88%97/" class="post-category">
                                大数据运维系列
                            </a>
                        
                            <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE%E8%BF%90%E7%BB%B4%E7%B3%BB%E5%88%97/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B3%BB%E5%88%97/" class="post-category">
                                数据库系列
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2024-11-13
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2024-11-14
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    11k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    48 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.min.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="ClickHouse"><a href="#ClickHouse" class="headerlink" title="ClickHouse"></a>ClickHouse</h1><p>官网：<a target="_blank" rel="noopener" href="https://clickhouse.com/">https://clickhouse.com/</a></p>
<p>官方文档：<a target="_blank" rel="noopener" href="https://clickhouse.com/docs/en/intro">https://clickhouse.com/docs/en/intro</a></p>
<p>tgz包下载：<a target="_blank" rel="noopener" href="https://packages.clickhouse.com/tgz/stable/">https://packages.clickhouse.com/tgz/stable/</a></p>
<h2 id="1-ClickHouse简介："><a href="#1-ClickHouse简介：" class="headerlink" title="1. ClickHouse简介："></a>1. ClickHouse简介：</h2><p>ClickHouse 是俄罗斯的 Yandex 于2016年开源的<code>列式存储数据库</code>（DBMS)，主要用于<code>在线分析处理查询（OLAP）</code>，能够使用SQL 查询实时生成分析数据报告。</p>
<h3 id="1-1-什么是-OLAP-？"><a href="#1-1-什么是-OLAP-？" class="headerlink" title="1.1 什么是 OLAP ？"></a>1.1 什么是 OLAP ？</h3><p>OLAP 场景需要在大型数据集之上实时响应复杂的分析查询，具有以下特征：</p>
<ul>
<li>数据集可能非常庞大 - 数十亿或数万亿行</li>
<li>数据组织在包含许多列的表中</li>
<li>仅选择几列来回答任何特定查询</li>
<li>结果必须以毫秒或秒为单位返回</li>
</ul>
<h3 id="1-2-面向列与面向行的数据库"><a href="#1-2-面向列与面向行的数据库" class="headerlink" title="1.2 面向列与面向行的数据库"></a>1.2 面向列与面向行的数据库</h3><p>在面向行的 DBMS 中，数据存储在行中，与行相关的所有值物理上彼此相邻存储。</p>
<p>在面向列的 DBMS 中，数据存储在列中，同一列中的值存储在一起。</p>
<h3 id="1-3-ClickHouse-的特点"><a href="#1-3-ClickHouse-的特点" class="headerlink" title="1.3  ClickHouse 的特点"></a>1.3  ClickHouse 的特点</h3><h4 id="1-3-1-列式存储"><a href="#1-3-1-列式存储" class="headerlink" title="1.3.1 列式存储"></a>1.3.1 列式存储</h4><p>以下面的表为例：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>name</th>
<th>age</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>张三</td>
<td>18</td>
</tr>
<tr>
<td>2</td>
<td>李四</td>
<td>22</td>
</tr>
<tr>
<td>3</td>
<td>王五</td>
<td>34</td>
</tr>
</tbody></table>
<blockquote>
<p>1）采用行式存储时，数据在磁盘上的组织结构为:</p>
</blockquote>
<p><img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202401291505667.png" alt="image-20240129150508584"></p>
<p>​		好处是想查某个人所有的属性时，可以通过一次磁盘查找加顺序读取就可以。但是当想 查所有人的年龄时，需要不停的查找，或者全表扫描才行，遍历的很多数据都是不需要的。</p>
<blockquote>
<p>2）采用列式存储时，数据在磁盘上的组织结构为：</p>
</blockquote>
<p><img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202401291505409.png" alt="image-20240129150559349"></p>
<p>​		这时想查所有人的年龄只需把年龄那一列拿出来就可以了</p>
<blockquote>
<p>3）列式储存的好处：</p>
</blockquote>
<ul>
<li>对于列的聚合，计数，求和等统计操作原因优于行式存储。 </li>
<li>由于某一列的数据类型都是相同的，针对于数据存储更容易进行数据压缩，每一列 选择更优的数据压缩算法，大大提高了数据的压缩比重。 </li>
<li>由于数据压缩比更好，一方面节省了磁盘空间，另一方面对于 cache 也有了更大的 发挥空间。</li>
</ul>
<h4 id="1-3-2-DBMS-的功能"><a href="#1-3-2-DBMS-的功能" class="headerlink" title="1.3.2  DBMS 的功能"></a>1.3.2  DBMS 的功能</h4><p>​		几乎覆盖了标准 SQL 的大部分语法，包括 DDL 和 DML，以及配套的各种函数，用户管 理及权限管理，数据的备份与恢复</p>
<h4 id="1-3-3-多样化引擎"><a href="#1-3-3-多样化引擎" class="headerlink" title="1.3.3 多样化引擎"></a>1.3.3 多样化引擎</h4><p>​		ClickHouse 和 MySQL 类似，把表级的存储引擎插件化，根据表的不同需求可以设定不同 的存储引擎。目前包括合并树、日志、接口和其他四大类 20 多种引擎。</p>
<h4 id="1-3-4-高吞吐写入能力"><a href="#1-3-4-高吞吐写入能力" class="headerlink" title="1.3.4 高吞吐写入能力"></a>1.3.4 高吞吐写入能力</h4><p>​		ClickHouse 采用类<code>LSM Tree</code>的结构，数据写入后定期在后台 Compaction。通过类 LSM tree 的结构，ClickHouse 在数据导入时全部是顺序 append 写，写入后数据段不可更改，在后台 compaction 时也是多个段 merge sort 后顺序写回磁盘。顺序写的特性，充分利用了磁盘的吞 吐能力，即便在 HDD 上也有着优异的写入性能。 </p>
<p>​		官方公开 benchmark 测试显示能够达到 50MB-200MB&#x2F;s 的写入吞吐能力，按照每行 100Byte 估算，大约相当于 50W-200W 条&#x2F;s 的写入速度。</p>
<h4 id="1-3-5-数据分区与线程级并行"><a href="#1-3-5-数据分区与线程级并行" class="headerlink" title="1.3.5 数据分区与线程级并行"></a>1.3.5 数据分区与线程级并行</h4><p>​		ClickHouse 将数据划分为多个 partition，每个 partition 再进一步划分为多个 index  granularity(索引粒度)，然后通过多个 CPU核心分别处理其中的一部分来实现并行数据处理。 在这种设计下，<code>单条 Query 就能利用整机所有 CPU</code>。极致的并行处理能力，极大的降低了查 询延时。 </p>
<p>​		所以，ClickHouse 即使对于大量数据的查询也能够化整为零平行处理。但是有一个弊端 就是对于单条查询使用多 cpu，就不利于同时并发多条查询。所以对于高 qps 的查询业务， ClickHouse 并不是强项。</p>
<h3 id="1-4-Clickhouse安装包："><a href="#1-4-Clickhouse安装包：" class="headerlink" title="1.4 Clickhouse安装包："></a>1.4 Clickhouse安装包：</h3><table>
<thead>
<tr>
<th>包名</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>clickhouse-client</td>
<td>包含 clickhouse 客户端交互工具</td>
</tr>
<tr>
<td>clickhouse-common</td>
<td>包含 clickhouse 服务端执行脚本</td>
</tr>
<tr>
<td>clickhouse-server</td>
<td>包含 clickhouse 服务端配置文件</td>
</tr>
</tbody></table>
<h3 id="1-5-安装后主要分布目录："><a href="#1-5-安装后主要分布目录：" class="headerlink" title="1.5 安装后主要分布目录："></a>1.5 安装后主要分布目录：</h3><table>
<thead>
<tr>
<th>路径</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;etc&#x2F;clickhouse-server</td>
<td>clickhouse 服务端配置文件目录</td>
</tr>
<tr>
<td>&#x2F;etc&#x2F;clickhouse-client</td>
<td>clickhouse 客户端配置文件目录</td>
</tr>
<tr>
<td>&#x2F;var&#x2F;lib&#x2F;clickhouse</td>
<td>clickhouse 默认数据目录</td>
</tr>
<tr>
<td>&#x2F;var&#x2F;log&#x2F;clickhouse-server</td>
<td>clickhouse 默认日志目录</td>
</tr>
<tr>
<td>&#x2F;etc&#x2F;init.d&#x2F;clickhouse-server</td>
<td>clickhouse 服务端启动脚本</td>
</tr>
</tbody></table>
<pre><code>     关于tgz包安装部署方法，官网也写有安装脚本（个人感觉脚本拉取tgz包太慢，于是直接下载到了本地，再上传到linux服务器）
</code></pre>
<p>&#x3D;&#x3D;官网tgz包安装Clickhouse脚本&#x3D;&#x3D;：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token assign-left variable">LATEST_VERSION</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">curl</span> <span class="token parameter variable">-s</span> https://packages.clickhouse.com/tgz/stable/ <span class="token operator">|</span> <span class="token punctuation">\</span>
    <span class="token function">grep</span> <span class="token parameter variable">-Eo</span> <span class="token string">'[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+'</span> <span class="token operator">|</span> <span class="token function">sort</span> <span class="token parameter variable">-V</span> <span class="token parameter variable">-r</span> <span class="token operator">|</span> <span class="token function">head</span> <span class="token parameter variable">-n</span> <span class="token number">1</span><span class="token variable">)</span></span>
<span class="token builtin class-name">export</span> LATEST_VERSION

<span class="token keyword">case</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> <span class="token parameter variable">-m</span><span class="token variable">)</span></span> <span class="token keyword">in</span>
  x86_64<span class="token punctuation">)</span> <span class="token assign-left variable">ARCH</span><span class="token operator">=</span>amd64 <span class="token punctuation">;</span><span class="token punctuation">;</span>
  aarch64<span class="token punctuation">)</span> <span class="token assign-left variable">ARCH</span><span class="token operator">=</span>arm64 <span class="token punctuation">;</span><span class="token punctuation">;</span>
  *<span class="token punctuation">)</span> <span class="token builtin class-name">echo</span> <span class="token string">"Unknown architecture <span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> <span class="token parameter variable">-m</span><span class="token variable">)</span></span>"</span><span class="token punctuation">;</span> <span class="token builtin class-name">exit</span> <span class="token number">1</span> <span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token keyword">esac</span>

<span class="token keyword">for</span> <span class="token for-or-select variable">PKG</span> <span class="token keyword">in</span> clickhouse-common-static clickhouse-common-static-dbg clickhouse-server clickhouse-client clickhouse-keeper
<span class="token keyword">do</span>
  <span class="token function">curl</span> <span class="token parameter variable">-fO</span> <span class="token string">"https://packages.clickhouse.com/tgz/stable/<span class="token variable">$PKG</span>-<span class="token variable">$LATEST_VERSION</span>-<span class="token variable">$&#123;ARCH&#125;</span>.tgz"</span> <span class="token punctuation">\</span>
    <span class="token operator">||</span> <span class="token function">curl</span> <span class="token parameter variable">-fO</span> <span class="token string">"https://packages.clickhouse.com/tgz/stable/<span class="token variable">$PKG</span>-<span class="token variable">$LATEST_VERSION</span>.tgz"</span>
<span class="token keyword">done</span>

<span class="token function">tar</span> <span class="token parameter variable">-xzvf</span> <span class="token string">"clickhouse-common-static-<span class="token variable">$LATEST_VERSION</span>-<span class="token variable">$&#123;ARCH&#125;</span>.tgz"</span> <span class="token punctuation">\</span>
  <span class="token operator">||</span> <span class="token function">tar</span> <span class="token parameter variable">-xzvf</span> <span class="token string">"clickhouse-common-static-<span class="token variable">$LATEST_VERSION</span>.tgz"</span>
<span class="token function">sudo</span> <span class="token string">"clickhouse-common-static-<span class="token variable">$LATEST_VERSION</span>/install/doinst.sh"</span>

<span class="token function">tar</span> <span class="token parameter variable">-xzvf</span> <span class="token string">"clickhouse-common-static-dbg-<span class="token variable">$LATEST_VERSION</span>-<span class="token variable">$&#123;ARCH&#125;</span>.tgz"</span> <span class="token punctuation">\</span>
  <span class="token operator">||</span> <span class="token function">tar</span> <span class="token parameter variable">-xzvf</span> <span class="token string">"clickhouse-common-static-dbg-<span class="token variable">$LATEST_VERSION</span>.tgz"</span>
<span class="token function">sudo</span> <span class="token string">"clickhouse-common-static-dbg-<span class="token variable">$LATEST_VERSION</span>/install/doinst.sh"</span>

<span class="token function">tar</span> <span class="token parameter variable">-xzvf</span> <span class="token string">"clickhouse-server-<span class="token variable">$LATEST_VERSION</span>-<span class="token variable">$&#123;ARCH&#125;</span>.tgz"</span> <span class="token punctuation">\</span>
  <span class="token operator">||</span> <span class="token function">tar</span> <span class="token parameter variable">-xzvf</span> <span class="token string">"clickhouse-server-<span class="token variable">$LATEST_VERSION</span>.tgz"</span>
<span class="token function">sudo</span> <span class="token string">"clickhouse-server-<span class="token variable">$LATEST_VERSION</span>/install/doinst.sh"</span> configure
<span class="token function">sudo</span> /etc/init.d/clickhouse-server start

<span class="token function">tar</span> <span class="token parameter variable">-xzvf</span> <span class="token string">"clickhouse-client-<span class="token variable">$LATEST_VERSION</span>-<span class="token variable">$&#123;ARCH&#125;</span>.tgz"</span> <span class="token punctuation">\</span>
  <span class="token operator">||</span> <span class="token function">tar</span> <span class="token parameter variable">-xzvf</span> <span class="token string">"clickhouse-client-<span class="token variable">$LATEST_VERSION</span>.tgz"</span>
<span class="token function">sudo</span> <span class="token string">"clickhouse-client-<span class="token variable">$LATEST_VERSION</span>/install/doinst.sh"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="2-手动部署clickhouse"><a href="#2-手动部署clickhouse" class="headerlink" title="2. 手动部署clickhouse"></a>2. 手动部署clickhouse</h2><h3 id="2-1-解压安装包"><a href="#2-1-解压安装包" class="headerlink" title="2.1 解压安装包"></a>2.1 解压安装包</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@master opt<span class="token punctuation">]</span><span class="token comment"># mkdir /opt/module/clickhouse</span>
<span class="token punctuation">[</span>root@master opt<span class="token punctuation">]</span><span class="token comment"># tar -zxf clickhouse-common-static-21.9.4.35.tgz -C /opt/module/clickhouse</span>
<span class="token punctuation">[</span>root@master opt<span class="token punctuation">]</span><span class="token comment"># tar -zxf clickhouse-common-static-dbg-21.9.4.35.tgz -C /opt/module/clickhouse</span>
<span class="token punctuation">[</span>root@master opt<span class="token punctuation">]</span><span class="token comment"># tar -zxf clickhouse-server-21.9.4.35.tgz -C /opt/module/clickhouse</span>
<span class="token punctuation">[</span>root@master opt<span class="token punctuation">]</span><span class="token comment"># tar -zxf clickhouse-client-21.9.4.35.tgz -C /opt/module/clickhouse</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-2-解压后依照顺序执行每个clickhouse-install下的doinst-sh命令"><a href="#2-2-解压后依照顺序执行每个clickhouse-install下的doinst-sh命令" class="headerlink" title="2.2 解压后依照顺序执行每个clickhouse&#x2F;install下的doinst.sh命令"></a>2.2 解压后依照顺序执行每个clickhouse&#x2F;install下的doinst.sh命令</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@master clickhouse-common-static-21.9.4.35<span class="token punctuation">]</span><span class="token comment"># install/doinst.sh</span>
<span class="token punctuation">[</span>root@master clickhouse-common-static-dbg-21.9.4.35<span class="token punctuation">]</span><span class="token comment"># install/doinst.sh</span>
<span class="token punctuation">[</span>root@master clickhouse-server-21.9.4.35<span class="token punctuation">]</span><span class="token comment"># install/doinst.sh</span>

<span class="token punctuation">[</span>root@bigdata1 clickhouse<span class="token punctuation">]</span><span class="token comment"># sh clickhouse-common-static-21.9.4.35/install/doinst.sh</span>
<span class="token punctuation">[</span>root@bigdata1 clickhouse<span class="token punctuation">]</span><span class="token comment"># sh clickhouse-common-static-dbg-21.9.4.35/install/doinst.sh </span>
<span class="token punctuation">[</span>root@bigdata1 clickhouse<span class="token punctuation">]</span><span class="token comment"># sh clickhouse-server-21.9.4.35/install/doinst.sh </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>执行 clickhouse-server 会创建一个用户 default 并<code>让你设置密码</code>，直接回车密码设置为空</p>
</blockquote>
<p><img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202309241309536.png" alt="image-20230825134747331"></p>
<blockquote>
<p>是否设置ClickHouse服务器的网络连接权限(选择y)</p>
</blockquote>
<p><img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202309241309876.png"></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@bigdata1 clickhouse<span class="token punctuation">]</span><span class="token comment"># sh clickhouse-client-21.9.4.35/install/doinst.sh</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>设置<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E8%BF%9C%E7%A8%8B%E8%AE%BF%E9%97%AE&spm=1001.2101.3001.7020">远程访问</a>并移除默认监听文件（listen.xml），同时由于9000端口被hadoop占用，需要将clickhouse的端口更改为9001</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>没有就不理<span class="token punctuation">)</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># rm -rf /etc/clickhouse-server/listen.xml</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<blockquote>
<p>修改前先备份</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># cp /etc/clickhouse-server/config.xml /etc/clickhouse-server/config.xml.bak</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>给config.xml加权限</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># chmod 777 /etc/clickhouse-server/config.xml</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>编辑config.xml 文件</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># vi /etc/clickhouse-server/config.xml</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<p>取消掉<!-- <listen_host>0.0.0.0</listen_host> -->的注释变为：<listen_host>0.0.0.0</listen_host><br>将里面所有的9000变成9001</p>
</blockquote>
<p>快速修改指令:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s/9000/9001/g"</span> /etc/clickhouse-server/config.xml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h3 id="2-3-clickhouse启动"><a href="#2-3-clickhouse启动" class="headerlink" title="2.3 clickhouse启动"></a>2.3 clickhouse启动</h3><blockquote>
<p>方式1:</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@master clickhouse-server-21.9.4.35<span class="token punctuation">]</span><span class="token comment"># clickhouse start</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202309241309305.jpeg" alt="img"></p>
<blockquote>
<p>方式2(推荐):</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">启动:
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># systemctl start clickhouse-server</span>
查看服务状态:
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># systemctl status clickhouse-server</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202401141240461.png" alt="image-20240114124027390"></p>
<h3 id="2-4-连接clickhouse-client"><a href="#2-4-连接clickhouse-client" class="headerlink" title="2.4 连接clickhouse-client"></a>2.4 连接clickhouse-client</h3><p>语法：</p>
<p>clickhouse-client –host&#x3D;主机地址 –port 端口 –user&#x3D;用户 –password&#x3D;密码 </p>
<p>参数：</p>
<ul>
<li>–host：指定要连接的ClickHouse服务器的主机名或IP地址。</li>
<li>–port：指定要连接的ClickHouse服务器的端口号，默认为9000。</li>
<li>–user：指定要使用的用户名进行身份验证，默认为”default”。</li>
<li>–password：指定要使用的密码进行身份验证。</li>
<li>–database：指定要使用的默认数据库。</li>
<li>–query：指定要在连接后立即执行的查询。</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">clickhouse-client <span class="token parameter variable">--host</span><span class="token operator">=</span>localhost <span class="token parameter variable">--port</span> <span class="token number">9001</span> <span class="token parameter variable">--user</span><span class="token operator">=</span>default <span class="token parameter variable">--password</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="2-5-执行SQL语句验证"><a href="#2-5-执行SQL语句验证" class="headerlink" title="2.5 执行SQL语句验证"></a>2.5 执行SQL语句验证</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">master :<span class="token punctuation">)</span> <span class="token keyword">show</span> <span class="token keyword">databases</span><span class="token punctuation">;</span>

<span class="token keyword">SHOW</span> <span class="token keyword">DATABASES</span>

Query id: <span class="token number">6</span>d54b636<span class="token operator">-</span>f017<span class="token operator">-</span><span class="token number">441</span>a<span class="token operator">-</span>adfc<span class="token operator">-</span><span class="token number">1</span>eb6e60e4676

┌─name────┐
│ <span class="token keyword">default</span> │
│ system  │
└─────────┘

<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">.</span> Elapsed: <span class="token number">0.002</span> sec<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>结果：<img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202309241309860.png" alt="image-20230825134052335"></p>
<h3 id="2-6-修改default用户密码"><a href="#2-6-修改default用户密码" class="headerlink" title="2.6 修改default用户密码"></a>2.6 修改default用户密码</h3><blockquote>
<p>源文件只读文件,添加可写(w)权限再进行修改</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">chmod</span> <span class="token number">755</span> /etc/clickhouse-server/users.xml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<p>修改配置后重启服务</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># vi /etc/clickhouse-server/users.xml</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>修改第68行参数(安装时回车已经设置密码为空,现在进行添加密码)</p>
<p><img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202401092245691.png" alt="image-20240109224506535"></p>
<p>例子参考:<img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202401092245864.png" alt="image-20240109224556801"></p>
<blockquote>
<p>重启服务</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">1</span>.关闭服务
clickhouse stop
systemctl stop clickhouse-server.service
<span class="token number">2</span>.启动服务
clickhouse start
systemctl start clickhouse-server.service<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>再次登录:</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># clickhouse-client --host=localhost --port 9001 --user=default --password 123456</span>
ClickHouse client version <span class="token number">21.9</span>.4.35 <span class="token punctuation">(</span>official build<span class="token punctuation">)</span>.
Connecting to localhost:9001 as user default.
Connected to ClickHouse server version <span class="token number">21.9</span>.4 revision <span class="token number">54449</span>.

master <span class="token builtin class-name">:</span><span class="token punctuation">)</span> show databases<span class="token punctuation">;</span>

SHOW DATABASES

Query id: 6ad41603-b367-4021-956a-c024b1af5175

┌─name────┐
│ default │
│ system  │
└─────────┘

<span class="token number">2</span> rows <span class="token keyword">in</span> set. Elapsed: <span class="token number">0.003</span> sec. 

master <span class="token builtin class-name">:</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>登录成功,密码设置成功</p>
<h3 id="2-7-开启远程连接"><a href="#2-7-开启远程连接" class="headerlink" title="2.7 开启远程连接"></a>2.7 开启远程连接</h3><p>修改配置文件:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># vim /etc/clickhouse-server/config.xml</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>将以下注释打开(大概156行左右):</p>
<p>(<code>这里会出现问题,直接跳到下面的问题解决</code>)</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>listen_host</span><span class="token punctuation">></span></span>::<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>listen_host</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>修改后如下:</p>
<p><img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202401262048414.png" alt="image-20240126204844344"></p>
<p> :warning: 修改后重启服务报错</p>
<p><img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202401262147649.png" alt="image-20240126214736560"></p>
<p>查看日志发现关键报错信息:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># tailf /var/log/clickhouse-server/clickhouse-server.log</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202401262148148.png" alt="image-20240126214815077"></p>
<p>OS禁用IPv6后配置：<listen_host>::</listen_host>，该配置支持了IPv4和IPv6，而OS又禁用了IPv6会导致报错如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token operator">&lt;</span>Error<span class="token operator">></span> Application: DB::Exception: Listen <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:8123 failed: Poco::Exception. Code: <span class="token number">1000</span>, e.code<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>, DNS error: EAI: Address family <span class="token keyword">for</span> <span class="token function">hostname</span> not supported <span class="token punctuation">(</span>version <span class="token number">21.9</span>.4.35 <span class="token punctuation">(</span>official build<span class="token punctuation">))</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">尖叫提示（1）：
在禁用了ipv6时，如果使用<span class="token operator">&lt;</span>listen_host<span class="token operator">></span>::<span class="token operator">&lt;</span>/listen_host<span class="token operator">></span>配置，会报如下错误
Application: DB::Exception: Listen <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:8123 failed: Poco::Exception. Code: <span class="token number">1000</span>, e.code<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token number">0</span>, e.displayText<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> DNS error: EAI: <span class="token parameter variable">-9</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token operator">&lt;</span><span class="token operator">!</span>-- 如果禁用了ipv6，使用下面配置--<span class="token operator">></span>
<span class="token operator">&lt;</span>listen_host<span class="token operator">></span><span class="token number">0.0</span>.0.<span class="token operator"><span class="token file-descriptor important">0</span>&lt;</span>/listen_host<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">!</span>-- 如果没有禁用ipv6，使用下面配置
<span class="token operator">&lt;</span>listen_host<span class="token operator">></span>::<span class="token operator">&lt;</span>/listen_host<span class="token operator">></span>
--<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>:star:问题解决:</p>
<blockquote>
<p>将<listen_host>::</listen_host>改成<listen_host>0.0.0.0</listen_host></p>
</blockquote>
<p><img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202401262200833.png" alt="image-20240126220044758"></p>
<h3 id="2-8-安装脚本-参考"><a href="#2-8-安装脚本-参考" class="headerlink" title="2.8 安装脚本(参考)"></a>2.8 安装脚本(参考)</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token comment">#脚本放再tgz包目录执行</span>
<span class="token function">mkdir</span> /opt/clickhouse
<span class="token assign-left variable">client_tgz</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">ls</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"client"</span><span class="token variable">`</span></span>
<span class="token assign-left variable">commondbg_tgz</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">ls</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">'common'</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">"NR==2&#123;print <span class="token variable">$1</span>&#125;"</span><span class="token variable">`</span></span>
<span class="token assign-left variable">common_tgz</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">ls</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">'common'</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">"NR==1&#123;print <span class="token variable">$1</span>&#125;"</span><span class="token variable">`</span></span>
<span class="token assign-left variable">server_tgz</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">ls</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"server"</span><span class="token variable">`</span></span>

<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF
************************
** 开始安装clickhouse **
************************
EOF</span>
<span class="token builtin class-name">echo</span> <span class="token string">">>开始解压client"</span>
<span class="token function">tar</span> <span class="token parameter variable">-zxf</span> <span class="token variable">$client_tgz</span> <span class="token parameter variable">-C</span> /opt/clickhouse
<span class="token builtin class-name">echo</span> <span class="token string">">>开始解压common-dbg"</span>
<span class="token function">tar</span> <span class="token parameter variable">-zxf</span> <span class="token variable">$commondbg_tgz</span> <span class="token parameter variable">-C</span> /opt/clickhouse
<span class="token builtin class-name">echo</span> <span class="token string">">>开始解压common"</span>
<span class="token function">tar</span> <span class="token parameter variable">-zxf</span> <span class="token variable">$common_tgz</span> <span class="token parameter variable">-C</span> /opt/clickhouse
<span class="token builtin class-name">echo</span> <span class="token string">">>开始解压server"</span>
<span class="token function">tar</span> <span class="token parameter variable">-zxf</span> <span class="token variable">$server_tgz</span> <span class="token parameter variable">-C</span> /opt/clickhouse

<span class="token assign-left variable">client</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">ls</span> /opt/clickhouse<span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"client"</span><span class="token variable">`</span></span>
<span class="token assign-left variable">commondbg</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">ls</span> /opt/clickhouse <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"common-static-dbg"</span><span class="token variable">`</span></span>
<span class="token assign-left variable">common</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">ls</span> /opt/clickhouse <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"common"</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">"NR==1&#123;print <span class="token variable">$1</span>&#125;"</span><span class="token variable">`</span></span>
<span class="token assign-left variable">server</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">ls</span> /opt/clickhouse <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"server"</span><span class="token variable">`</span></span>

<span class="token function">sh</span> /opt/clickhouse/<span class="token variable">$common</span>/install/doinst.sh
<span class="token function">sh</span> /opt/clickhouse/<span class="token variable">$commondbg</span>/install/doinst.sh
<span class="token comment"># 执行 clickhouse-server 会创建一个用户 default 并让你设置密码，直接回车密码设置为空</span>
<span class="token builtin class-name">echo</span>  <span class="token string">"=====设置default用户密码(回车设置密码为空)======"</span> 
<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF
*******************************************
** 设置default用户密码(回车设置密码为空) **
** 是否设置ClickHouse服务器的网络连接权限**
*******************************************
EOF</span>
<span class="token function">sh</span> /opt/clickhouse/<span class="token variable">$server</span>/install/doinst.sh <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token number">1</span> /dev/null
<span class="token function">sh</span> /opt/clickhouse/<span class="token variable">$client</span>/install/doinst.sh

<span class="token builtin class-name">read</span> <span class="token parameter variable">-p</span> <span class="token string">"是否修改clickhouse默认端口(y/n):"</span> yn
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$yn</span> <span class="token operator">==</span> <span class="token string">'y'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
  <span class="token builtin class-name">read</span> <span class="token parameter variable">-p</span> <span class="token string">"修改的端口为:"</span> port
  <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s/9000/<span class="token variable">$port</span>/g"</span> /etc/clickhouse-server/config.xml
  <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$?</span> <span class="token parameter variable">-eq</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
   <span class="token builtin class-name">echo</span> <span class="token string">">clickhouse端口已更改成:<span class="token variable">$port</span>"</span>
  <span class="token keyword">else</span> 
   <span class="token builtin class-name">echo</span> <span class="token string">"修改失败！！"</span>
  <span class="token keyword">fi</span>
<span class="token keyword">else</span>
  <span class="token builtin class-name">echo</span> <span class="token string">">clickhouse默认端口为: 9000 "</span>
<span class="token keyword">fi</span>

<span class="token comment">#启动</span>
<span class="token builtin class-name">echo</span> <span class="token string">"=====启动====="</span>
clickhouse start
<span class="token builtin class-name">echo</span> <span class="token string">"=====状态====="</span>
clickhouse status

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$?</span> <span class="token parameter variable">-eq</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
  <span class="token builtin class-name">read</span> <span class="token parameter variable">-p</span> <span class="token string">"是否查看登录帮助(y/n)"</span> <span class="token builtin class-name">help</span>
  <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$help</span> <span class="token operator">==</span> <span class="token string">'y'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF
语法：clickhouse-client --host=主机地址 --port 端口 --user=用户 --password=密码 
参数:
	--host：指定要连接的ClickHouse服务器的主机名或IP地址。
	--port：指定要连接的ClickHouse服务器的端口号，默认为9000。
	--user：指定要使用的用户名进行身份验证，默认为"default"。
	--password：指定要使用的密码进行身份验证。
	--database：指定要使用的默认数据库。
	--query：指定要在连接后立即执行的查询。
EOF</span>
<span class="token keyword">fi</span>

<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF
************************
** clickhouse安装完成 **
************************
EOF</span>
<span class="token keyword">else</span>
<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF
**************************************
** clickhouse安装失败（请检查配置） **
**************************************
EOF</span>
<span class="token keyword">fi</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="3-数据类型"><a href="#3-数据类型" class="headerlink" title="3. 数据类型"></a>3. 数据类型</h2><h3 id="3-1-整型"><a href="#3-1-整型" class="headerlink" title="3.1 整型"></a>3.1 整型</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">固定长度的整型，包括有符号整型或无符号整型。
整型范围（<span class="token operator">-</span><span class="token number">2</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token operator">~</span><span class="token number">2</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span><span class="token number">1</span>）：
Int8 <span class="token operator">-</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">128</span> : <span class="token number">127</span><span class="token punctuation">]</span>
Int16 <span class="token operator">-</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">32768</span> : <span class="token number">32767</span><span class="token punctuation">]</span>
Int32 <span class="token operator">-</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2147483648</span> : <span class="token number">2147483647</span><span class="token punctuation">]</span>
Int64 <span class="token operator">-</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">9223372036854775808</span> : <span class="token number">9223372036854775807</span><span class="token punctuation">]</span>
无符号整型范围（<span class="token number">0</span><span class="token operator">~</span><span class="token number">2</span>n<span class="token operator">-</span><span class="token number">1</span>）：
UInt8 <span class="token operator">-</span> <span class="token punctuation">[</span><span class="token number">0</span> : <span class="token number">255</span><span class="token punctuation">]</span>
UInt16 <span class="token operator">-</span> <span class="token punctuation">[</span><span class="token number">0</span> : <span class="token number">65535</span><span class="token punctuation">]</span>
UInt32 <span class="token operator">-</span> <span class="token punctuation">[</span><span class="token number">0</span> : <span class="token number">4294967295</span><span class="token punctuation">]</span>
UInt64 <span class="token operator">-</span> <span class="token punctuation">[</span><span class="token number">0</span> : <span class="token number">18446744073709551615</span><span class="token punctuation">]</span>
使用场景： 个数、数量、也可以存储型 id。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="3-2-浮点型"><a href="#3-2-浮点型" class="headerlink" title="3.2 浮点型"></a>3.2 浮点型</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">Float32 <span class="token operator">-</span> <span class="token keyword">float</span>
Float64 – <span class="token keyword">double</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>建议尽可能以整数形式存储数据。例如，将固定精度的数字转换为整数值，如时间用毫秒为单位表示，因为浮点型进行计算时可能引起四舍五入的误差。</p>
<p><img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202401291531147.png" alt="image-20240129153115084"></p>
<p><code>使用场景：一般数据值比较小，不涉及大量的统计计算，精度要求不高的时候。比如 保存商品的重量。</code></p>
<h3 id="3-3-布尔型"><a href="#3-3-布尔型" class="headerlink" title="3.3 布尔型"></a>3.3 布尔型</h3><p>没有单独的类型来存储布尔值。可以使用 UInt8 类型，取值限制为 0 或 1。</p>
<h3 id="3-4-Decimal-型"><a href="#3-4-Decimal-型" class="headerlink" title="3.4 Decimal 型"></a>3.4 Decimal 型</h3><p>有符号的浮点数，可在加、减和乘法运算过程中保持精度。对于除法，最低有效数字会 被丢弃（不舍入）。</p>
<p>有三种声明：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">➢ Decimal32<span class="token punctuation">(</span>s<span class="token punctuation">)</span>，相当于 Decimal<span class="token punctuation">(</span><span class="token number">9</span>-s,s<span class="token punctuation">)</span>，有效位数为 <span class="token number">1</span>~9
➢ Decimal64<span class="token punctuation">(</span>s<span class="token punctuation">)</span>，相当于 Decimal<span class="token punctuation">(</span><span class="token number">18</span>-s,s<span class="token punctuation">)</span>，有效位数为 <span class="token number">1</span>~18
➢ Decimal128<span class="token punctuation">(</span>s<span class="token punctuation">)</span>，相当于 Decimal<span class="token punctuation">(</span><span class="token number">38</span>-s,s<span class="token punctuation">)</span>，有效位数为 <span class="token number">1</span>~38<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><code>s 标识小数位</code></p>
<blockquote>
<p>使用场景： </p>
</blockquote>
<p>一般金额字段、汇率、利率等字段为了保证小数点精度，都使用 Decimal 进行存储。</p>
<h3 id="3-5-字符串"><a href="#3-5-字符串" class="headerlink" title="3.5 字符串"></a>3.5 字符串</h3><blockquote>
<p>1）String :star:</p>
</blockquote>
<p>字符串可以任意长度的。它可以包含任意的字节集，包含空字节。</p>
<blockquote>
<p>2）FixedString(N)</p>
</blockquote>
<p>​		固定长度 N 的字符串，N 必须是严格的正自然数。当服务端读取长度小于 N 的字符 串时候，通过在字符串末尾添加空字节来达到 N 字节长度。 当服务端读取长度大于 N 的 字符串时候，将返回错误消息。 </p>
<p>​		与 String 相比，极少会使用 FixedString，因为使用起来不是很方便。</p>
<blockquote>
<p>使用场景：</p>
</blockquote>
<p>​		名称、文字描述、字符型编码。 固定长度的可以保存一些定长的内容，比 如一些编码，性别等但是考虑到一定的变化风险，带来收益不够明显，所以定长字符串使用 意义有限。</p>
<h3 id="3-6-枚举类型"><a href="#3-6-枚举类型" class="headerlink" title="3.6 枚举类型"></a>3.6 枚举类型</h3><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">包括 Enum8 和 Enum16 类型。Enum 保存 <span class="token string">'string'</span>= integer 的对应关系。
Enum8 用 <span class="token string">'String'</span>= Int8 对描述。
Enum16 用 <span class="token string">'String'</span>= Int16 对描述。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>1）用法演示</p>
</blockquote>
<p>创建一个带有一个枚举 Enum8(‘hello’ &#x3D; 1, ‘world’ &#x3D; 2) 类型的列</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> t_enum
<span class="token punctuation">(</span>
 x Enum8<span class="token punctuation">(</span><span class="token string">'hello'</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'world'</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token keyword">ENGINE</span> <span class="token operator">=</span> TinyLog<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>2）这个 x 列只能存储类型定义中列出的值：’hello’或’world’</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">master :<span class="token punctuation">)</span>  <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_enum <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'world'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202401291536163.png" alt="image-20240129153658091"></p>
<blockquote>
<p>3）如果尝试保存任何其他值，ClickHouse 抛出异常</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">master :<span class="token punctuation">)</span>  <span class="token keyword">insert</span> <span class="token keyword">into</span> t_enum <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202401291537974.png" alt="image-20240129153754911"></p>
<blockquote>
<p>4）如果需要看到对应行的数值，则必须将 Enum 值转换为整数类型</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> CAST<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token string">'Int8'</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> t_enum<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202401291539305.png" alt="image-20240129153917241"></p>
<blockquote>
<p>使用场景：</p>
</blockquote>
<p>​		对一些状态、类型的字段算是一种空间优化，也算是一种数据约束。但是实 际使用中往往因为一些数据内容的变化增加一定的维护成本，甚至是数据丢失问题。所以谨 慎使用。</p>
<h3 id="3-7-时间类型"><a href="#3-7-时间类型" class="headerlink" title="3.7 时间类型"></a>3.7 时间类型</h3><p>目前 ClickHouse 有三种时间类型:</p>
<pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">➢ Date 接受年<span class="token operator">-</span>月<span class="token operator">-</span>日的字符串比如 ‘2019-12-16’
➢ Datetime 接受年<span class="token operator">-</span>月<span class="token operator">-</span>日 时:分:秒的字符串比如 ‘2019-12-16 20:50:10’
➢ Datetime64 接受年<span class="token operator">-</span>月<span class="token operator">-</span>日 时:分:秒<span class="token punctuation">.</span>亚秒的字符串比如‘2019-12-16 20:50:10<span class="token punctuation">.</span>66’<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>日期类型，用两个字节存储，表示从 1970-01-01 (无符号) 到当前的日期值。 还有很多数据结构，可以参考官方文档：<a target="_blank" rel="noopener" href="https://clickhouse.yandex/docs/zh/data_types/">https://clickhouse.yandex/docs/zh/data_types/</a></p>
<h3 id="3-8-数组"><a href="#3-8-数组" class="headerlink" title="3.8 数组"></a>3.8 数组</h3><p>Array(T)：由 T 类型元素组成的数组。 </p>
<p>​		T 可以是任意类型，包含数组类型。 但不推荐使用多维数组，ClickHouse 对多维数组 的支持有限。例如，不能在 MergeTree 表中存储多维数组。</p>
<blockquote>
<p>（1）创建数组方式 1，使用 array 函数</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">array<span class="token punctuation">(</span>T<span class="token punctuation">)</span>
master :<span class="token punctuation">)</span> <span class="token keyword">SELECT</span> array<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> x<span class="token punctuation">,</span> toTypeName<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202401291542838.png" alt="image-20240129154216776"></p>
<blockquote>
<p>（2）创建数组方式 2：使用方括号</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token punctuation">[</span><span class="token punctuation">]</span>
master :<span class="token punctuation">)</span> <span class="token keyword">SELECT</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token keyword">AS</span> x<span class="token punctuation">,</span> toTypeName<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202401291543281.png" alt="image-20240129154312218"></p>
<h2 id="4-表引擎"><a href="#4-表引擎" class="headerlink" title="4. 表引擎"></a>4. 表引擎</h2><h3 id="4-1-表引擎的使用"><a href="#4-1-表引擎的使用" class="headerlink" title="4.1 表引擎的使用"></a>4.1 表引擎的使用</h3><p>表引擎是 ClickHouse 的一大特色。可以说， 表引擎决定了如何存储表的数据。包括：</p>
<pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">➢ 数据的存储方式和位置，写到哪里以及从哪里读取数据。
➢ 支持哪些查询以及如何支持。
➢ 并发数据访问。
➢ 索引的使用（如果存在）。
➢ 是否可以执行多线程请求。
➢ 数据复制参数。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>表引擎的使用方式就是必须显式在创建表时定义该表使用的引擎，以及引擎使用的相关 参数。</p>
<p>:warning: 特别注意：引擎的名称大小写敏感</p>
<h3 id="4-2-TinyLog"><a href="#4-2-TinyLog" class="headerlink" title="4.2 TinyLog"></a>4.2 TinyLog</h3><p>​		以列文件的形式保存在磁盘上，<code>不支持索引</code>，<code>没有并发控制</code>。一般保存少量数据的小表， 生产环境上作用有限。可以用于平时练习测试用。</p>
<p>如:</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> t_tinylog <span class="token punctuation">(</span> id String<span class="token punctuation">,</span> name String<span class="token punctuation">)</span> <span class="token keyword">engine</span><span class="token operator">=</span>TinyLog<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202401291545458.png" alt="image-20240129154558392"></p>
<h3 id="4-3-Memory"><a href="#4-3-Memory" class="headerlink" title="4.3 Memory"></a>4.3 Memory</h3><p>​		内存引擎，数据以未压缩的原始形式直接<code>保存在内存当中</code>，服务器重启数据就会消失。 读写操作不会相互阻塞，<code>不支持索引</code>。简单查询下有非常非常高的性能表现（超过 10G&#x2F;s）。</p>
<p>​		一般用到它的地方不多，除了用来测试，就是在需要非常高的性能，同时数据量又不太 大（上限大概 1 亿行）的场景。</p>
<h3 id="4-4-MergeTree"><a href="#4-4-MergeTree" class="headerlink" title="4.4 MergeTree"></a>4.4 MergeTree</h3><p>​		ClickHouse 中最<code>强大的表引擎当属</code> MergeTree（合并树）引擎及该系列（*MergeTree） 中的其他引擎，<code>支持索引和分区</code>，地位可以相当于 innodb 之于 Mysql。而且基于 MergeTree， 还衍生除了很多小弟，也是非常有特色的引擎。</p>
<blockquote>
<p>1）建表语句</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> t_order_mt<span class="token punctuation">(</span>
 id UInt32<span class="token punctuation">,</span>
 sku_id String<span class="token punctuation">,</span>
 total_amount <span class="token keyword">Decimal</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 create_time <span class="token keyword">Datetime</span>
<span class="token punctuation">)</span> <span class="token keyword">engine</span> <span class="token operator">=</span>MergeTree
 <span class="token keyword">partition</span> <span class="token keyword">by</span> toYYYYMMDD<span class="token punctuation">(</span>create_time<span class="token punctuation">)</span>
 <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
 <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span>sku_id<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202401291548219.png" alt="image-20240129154852133"></p>
<blockquote>
<p>2）插入数据</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">insert</span> <span class="token keyword">into</span> t_order_mt <span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token number">101</span><span class="token punctuation">,</span><span class="token string">'sku_001'</span><span class="token punctuation">,</span><span class="token number">1000.00</span><span class="token punctuation">,</span><span class="token string">'2023-06-01 12:00:00'</span><span class="token punctuation">)</span> <span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">102</span><span class="token punctuation">,</span><span class="token string">'sku_002'</span><span class="token punctuation">,</span><span class="token number">2000.00</span><span class="token punctuation">,</span><span class="token string">'2023-06-01 11:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">102</span><span class="token punctuation">,</span><span class="token string">'sku_004'</span><span class="token punctuation">,</span><span class="token number">2500.00</span><span class="token punctuation">,</span><span class="token string">'2023-06-01 12:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">102</span><span class="token punctuation">,</span><span class="token string">'sku_002'</span><span class="token punctuation">,</span><span class="token number">2000.00</span><span class="token punctuation">,</span><span class="token string">'2023-06-01 13:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">102</span><span class="token punctuation">,</span><span class="token string">'sku_002'</span><span class="token punctuation">,</span><span class="token number">12000.00</span><span class="token punctuation">,</span><span class="token string">'2023-06-01 13:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">102</span><span class="token punctuation">,</span><span class="token string">'sku_002'</span><span class="token punctuation">,</span><span class="token number">600.00</span><span class="token punctuation">,</span><span class="token string">'2023-06-02 12:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202401291550807.png" alt="image-20240129155022732"></p>
<p>查询:</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">master :<span class="token punctuation">)</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t_order_mt<span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> t_order_mt

Query id: c1c4210f<span class="token operator">-</span><span class="token number">596</span>c<span class="token operator">-</span><span class="token number">4165</span><span class="token operator">-</span><span class="token number">8057</span><span class="token operator">-</span><span class="token number">8</span>c41072a865b

┌──id─┬─sku_id──┬─total_amount─┬─────────create_time─┐
│ <span class="token number">101</span> │ sku_001 │         <span class="token number">1000</span> │ <span class="token number">2023</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │
│ <span class="token number">102</span> │ sku_002 │         <span class="token number">2000</span> │ <span class="token number">2023</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">00</span>:<span class="token number">00</span> │
│ <span class="token number">102</span> │ sku_002 │         <span class="token number">2000</span> │ <span class="token number">2023</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">13</span>:<span class="token number">00</span>:<span class="token number">00</span> │
│ <span class="token number">102</span> │ sku_002 │        <span class="token number">12000</span> │ <span class="token number">2023</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">13</span>:<span class="token number">00</span>:<span class="token number">00</span> │
│ <span class="token number">102</span> │ sku_004 │         <span class="token number">2500</span> │ <span class="token number">2023</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │
└─────┴─────────┴──────────────┴─────────────────────┘
┌──id─┬─sku_id──┬─total_amount─┬─────────create_time─┐
│ <span class="token number">102</span> │ sku_002 │          <span class="token number">600</span> │ <span class="token number">2023</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">02</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │
└─────┴─────────┴──────────────┴─────────────────────┘

<span class="token number">6</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">.</span> Elapsed: <span class="token number">0.003</span> sec<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>​		MergeTree 其实还有很多参数(绝大多数用默认值即可)，但是三个参数是更加重要的， 也涉及了关于 MergeTree 的很多概念。</p>
<h4 id="4-4-1-partition-by-分区-可选"><a href="#4-4-1-partition-by-分区-可选" class="headerlink" title="4.4.1 partition by 分区(可选)"></a>4.4.1 partition by 分区(可选)</h4><blockquote>
<p>1）作用</p>
</blockquote>
<p>学过 hive 的应该都不陌生，分区的目的主要是降低扫描的范围，优化查询速度</p>
<blockquote>
<p>2）如果不填</p>
</blockquote>
<p>只会使用一个分区。</p>
<blockquote>
<p>3）分区目录</p>
</blockquote>
<p>​		MergeTree 是以列文件+索引文件+表定义文件组成的，但是如果设定了分区那么这些文 件就会保存到不同的分区目录中。</p>
<blockquote>
<p>4）并行</p>
</blockquote>
<p>分区后，面对涉及跨分区的查询统计，ClickHouse 会以分区为单位并行处理。</p>
<blockquote>
<p>5）数据写入与分区合并</p>
</blockquote>
<p>​		任何一个批次的数据写入都会产生一个临时分区，不会纳入任何一个已有的分区。写入 后的某个时刻（大概 10-15 分钟后），ClickHouse 会自动执行合并操作（等不及也可以手动 通过 optimize 执行），把临时分区的数据，合并到已有分区中。</p>
<p>​		在 ClickHouse 中，<code>OPTIMIZE TABLE</code> 的目的是优化表的性能和磁盘使用。<code>FINAL</code> 关键字表示执行最终的优化，以便尽可能地减小表的体积和提高查询性能。</p>
<p>​		需要注意的是，<code>OPTIMIZE TABLE</code> 可能是一项消耗资源的操作，它可能会导致表在执行期间被锁定。因此，在执行这类操作之前，建议在系统低峰期进行，以避免对正在进行的其他操作造成干扰。</p>
<p>​		执行完这个命令后，ClickHouse 将尝试对表 <code>t_order_rmt</code> 进行最终优化，包括合并分区、清理无效数据等。这可以帮助提高查询性能，并释放不再需要的磁盘空间。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">optimize</span> <span class="token keyword">table</span> xxxx final<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<p>6）例如</p>
</blockquote>
<p>再次执行上面的插入操作:</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">insert</span> <span class="token keyword">into</span> t_order_mt <span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token number">101</span><span class="token punctuation">,</span><span class="token string">'sku_001'</span><span class="token punctuation">,</span><span class="token number">1000.00</span><span class="token punctuation">,</span><span class="token string">'2023-06-01 12:00:00'</span><span class="token punctuation">)</span> <span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">102</span><span class="token punctuation">,</span><span class="token string">'sku_002'</span><span class="token punctuation">,</span><span class="token number">2000.00</span><span class="token punctuation">,</span><span class="token string">'2023-06-01 11:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">102</span><span class="token punctuation">,</span><span class="token string">'sku_004'</span><span class="token punctuation">,</span><span class="token number">2500.00</span><span class="token punctuation">,</span><span class="token string">'2023-06-01 12:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">102</span><span class="token punctuation">,</span><span class="token string">'sku_002'</span><span class="token punctuation">,</span><span class="token number">2000.00</span><span class="token punctuation">,</span><span class="token string">'2023-06-01 13:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">102</span><span class="token punctuation">,</span><span class="token string">'sku_002'</span><span class="token punctuation">,</span><span class="token number">12000.00</span><span class="token punctuation">,</span><span class="token string">'2023-06-01 13:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">102</span><span class="token punctuation">,</span><span class="token string">'sku_002'</span><span class="token punctuation">,</span><span class="token number">600.00</span><span class="token punctuation">,</span><span class="token string">'2023-06-02 12:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>查看数据并没有纳入任何分区:</p>
<p><img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202401291555032.png" alt="image-20240129155530953"></p>
<p>手动 optimize 之后:</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">master :<span class="token punctuation">)</span> <span class="token keyword">optimize</span> <span class="token keyword">table</span> t_order_mt final<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>再次查询:</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">master :<span class="token punctuation">)</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t_order_mt<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202401291557458.png" alt="image-20240129155726376"></p>
<h4 id="4-4-2-primary-key-主键-可选"><a href="#4-4-2-primary-key-主键-可选" class="headerlink" title="4.4.2 primary key 主键(可选)"></a>4.4.2 primary key 主键(可选)</h4><p>​		ClickHouse 中的主键，和其他数据库不太一样，<strong>它只提供了数据的一级索引，但是却不 是唯一约束</strong>。这就意味着是可以存在相同 primary key 的数据的。</p>
<p>​		主键的设定主要依据是查询语句中的 where 条件。</p>
<p>​		根据条件通过对主键进行某种形式的二分查找，能够定位到对应的 index granularity,避 免了全表扫描。</p>
<p>​		index granularity： 直接翻译的话就是索引粒度，指在<code>稀疏索引</code>中两个相邻索引对应数 据的间隔。ClickHouse 中的 MergeTree 默认是 8192。官方不建议修改这个值，除非该列存在 大量重复值，比如在一个分区中几万行才有一个不同数据。</p>
<blockquote>
<p>稀疏索引：</p>
</blockquote>
<p><img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202401291559545.png" alt="image-20240129155928459"></p>
<p>​		稀疏索引的好处就是可以用很少的索引数据，定位更多的数据，代价就是只能定位到索 引粒度的第一行，然后再进行进行一点扫描。</p>
<h4 id="4-4-3-order-by（必选）"><a href="#4-4-3-order-by（必选）" class="headerlink" title="4.4.3 order by（必选）"></a>4.4.3 order by（必选）</h4><p>​		order by 设定了<code>分区内</code>的数据按照哪些字段顺序进行有序保存。<br>​		order by 是 MergeTree 中唯一一个必填项，甚至比 primary key 还重要，因为当用户不<br>设置主键的情况，很多处理会依照 order by 的字段进行处理（比如后面会讲的去重和汇总）。<br>​		<code>要求：主键必须是 order by 字段的前缀字段。</code><br>​		比如 order by 字段是 (id,sku_id) 那么主键必须是 id 或者(id,sku_id)</p>
<h4 id="4-4-4-二级索引"><a href="#4-4-4-二级索引" class="headerlink" title="4.4.4 二级索引"></a>4.4.4 二级索引</h4><p>​		目前在 ClickHouse 的官网上二级索引的功能在<code> v20.1.2.4 之前</code>是被标注为实验性的，在 这个版本之后默认是开启的。</p>
<blockquote>
<p>1）老版本使用二级索引前需要增加设置</p>
</blockquote>
<p>是否允许使用实验性的二级索引&#96;&#96;（v20.1.2.4 开始，这个参数已被删除，默认开启）&#96;</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">set</span> allow_experimental_data_skipping_indices<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<p>2）创建测试表</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> t_order_mt2<span class="token punctuation">(</span>
 id UInt32<span class="token punctuation">,</span>
 sku_id String<span class="token punctuation">,</span>
 total_amount <span class="token keyword">Decimal</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 create_time <span class="token keyword">Datetime</span><span class="token punctuation">,</span>
<span class="token keyword">INDEX</span> a total_amount <span class="token keyword">TYPE</span> minmax GRANULARITY <span class="token number">5</span>
<span class="token punctuation">)</span> <span class="token keyword">engine</span> <span class="token operator">=</span>MergeTree
 <span class="token keyword">partition</span> <span class="token keyword">by</span> toYYYYMMDD<span class="token punctuation">(</span>create_time<span class="token punctuation">)</span>
 <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
 <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span> sku_id<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202401291606358.png" alt="image-20240129160609251"></p>
<p>其中 GRANULARITY N 是设定二级索引对于一级索引粒度的粒度。</p>
<blockquote>
<p>3）插入数据</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">insert</span> <span class="token keyword">into</span> t_order_mt2 <span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token number">101</span><span class="token punctuation">,</span><span class="token string">'sku_001'</span><span class="token punctuation">,</span><span class="token number">1000.00</span><span class="token punctuation">,</span><span class="token string">'2023-06-01 12:00:00'</span><span class="token punctuation">)</span> <span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">102</span><span class="token punctuation">,</span><span class="token string">'sku_002'</span><span class="token punctuation">,</span><span class="token number">2000.00</span><span class="token punctuation">,</span><span class="token string">'2023-06-01 11:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">102</span><span class="token punctuation">,</span><span class="token string">'sku_004'</span><span class="token punctuation">,</span><span class="token number">2500.00</span><span class="token punctuation">,</span><span class="token string">'2023-06-01 12:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">102</span><span class="token punctuation">,</span><span class="token string">'sku_002'</span><span class="token punctuation">,</span><span class="token number">2000.00</span><span class="token punctuation">,</span><span class="token string">'2023-06-01 13:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">102</span><span class="token punctuation">,</span><span class="token string">'sku_002'</span><span class="token punctuation">,</span><span class="token number">12000.00</span><span class="token punctuation">,</span><span class="token string">'2023-06-01 13:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">102</span><span class="token punctuation">,</span><span class="token string">'sku_002'</span><span class="token punctuation">,</span><span class="token number">600.00</span><span class="token punctuation">,</span><span class="token string">'2023-06-02 12:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>4）对比效果</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># clickhouse-client --host master --user default --port 9001 --password 123456 --send_logs_level=trace &lt;&lt;&lt; 'select * from t_order_mt2 where total_amount > toDecimal32(900., 2)';</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202401291645111.png" alt="image-20240129164539979"></p>
<h4 id="4-4-5-数据-TTL"><a href="#4-4-5-数据-TTL" class="headerlink" title="4.4.5 数据 TTL"></a>4.4.5 数据 TTL</h4><p>TTL 即 Time To Live，MergeTree 提供了可以管理数据表或者列的<code>生命周期</code>的功能。</p>
<blockquote>
<p>1）列级别 TTL</p>
</blockquote>
<p>（1）创建测试表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> t_order_mt3<span class="token punctuation">(</span>
 id UInt32<span class="token punctuation">,</span>
 sku_id String<span class="token punctuation">,</span>
 total_amount <span class="token keyword">Decimal</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> TTL create_time<span class="token operator">+</span><span class="token keyword">interval</span> <span class="token number">10</span> <span class="token keyword">SECOND</span><span class="token punctuation">,</span>
 create_time <span class="token keyword">Datetime</span> 
<span class="token punctuation">)</span> <span class="token keyword">engine</span> <span class="token operator">=</span>MergeTree
<span class="token keyword">partition</span> <span class="token keyword">by</span> toYYYYMMDD<span class="token punctuation">(</span>create_time<span class="token punctuation">)</span>
 <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
 <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span> sku_id<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>主要的修改是将 <code>TTL</code> 设置应用到 <code>total_amount</code> 字段，并使用 <code>create_time</code> 加上 10 秒作为过期时间。这样，一旦数据的 <code>create_time</code> 字段的值超过了当前时间加上 10 秒，相关的数据行就会被自动删除。</p>
<p>（2）插入数据（注意：根据实际时间改变）</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">insert</span> <span class="token keyword">into</span> t_order_mt3 <span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token number">106</span><span class="token punctuation">,</span><span class="token string">'sku_001'</span><span class="token punctuation">,</span><span class="token number">1000.00</span><span class="token punctuation">,</span><span class="token string">'2024-01-29 17:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">107</span><span class="token punctuation">,</span><span class="token string">'sku_002'</span><span class="token punctuation">,</span><span class="token number">2000.00</span><span class="token punctuation">,</span><span class="token string">'2024-01-29 17:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">110</span><span class="token punctuation">,</span><span class="token string">'sku_003'</span><span class="token punctuation">,</span><span class="token number">600.00</span><span class="token punctuation">,</span><span class="token string">'2024-01-29 17:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>（3）手动合并，查看效果 到期后，指定的字段数据归 0</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">master :<span class="token punctuation">)</span> <span class="token keyword">optimize</span> <span class="token keyword">table</span> t_order_mt3 final<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202401291703160.png" alt="image-20240129170300068"></p>
<blockquote>
<p>2）表级 TTL</p>
</blockquote>
<p>下面的这条语句是数据会在 create_time 之后 10 秒丢失 </p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">alter</span> <span class="token keyword">table</span> t_order_mt3 <span class="token keyword">MODIFY</span> TTL create_time <span class="token operator">+</span> <span class="token keyword">INTERVAL</span> <span class="token number">10</span> <span class="token keyword">SECOND</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p> 涉及判断的字段必须是 Date 或者 Datetime 类型，推荐使用分区的日期字段。</p>
<p>能够使用的时间周期：</p>
<pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell"><span class="token operator">-</span> SECOND
<span class="token operator">-</span> MINUTE
<span class="token operator">-</span> HOUR
<span class="token operator">-</span> DAY
<span class="token operator">-</span> WEEK
<span class="token operator">-</span> MONTH
<span class="token operator">-</span> QUARTER
<span class="token operator">-</span> YEAR<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="4-5-ReplacingMergeTree"><a href="#4-5-ReplacingMergeTree" class="headerlink" title="4.5 ReplacingMergeTree"></a>4.5 ReplacingMergeTree</h3><p>​		ReplacingMergeTree 是 MergeTree 的一个变种，它存储特性完全&#96;&#96;继承 MergeTree<code>，只是 </code>多了一个去重的功能&#96;。 尽管 MergeTree 可以设置主键，但是 primary key 其实没有唯一约束 的功能。如果你想处理掉重复的数据，可以借助这个 ReplacingMergeTree。</p>
<blockquote>
<p>1）去重时机</p>
</blockquote>
<p>​		<code>数据的去重只会在合并的过程中出现</code>。合并会在未知的时间在后台进行，所以你无法预 先作出计划。有一些数据可能仍未被处理。</p>
<blockquote>
<p>2）去重范围</p>
</blockquote>
<p>​		<code>如果表经过了分区，去重只会在分区内部进行去重，不能执行跨分区的去重。</code></p>
<p>​		所以 ReplacingMergeTree 能力有限， ReplacingMergeTree 适用于在后台清除重复的数 据以节省空间，但是它<code>不保证没有重复的数据出现。</code></p>
<blockquote>
<p>3）案例演示</p>
</blockquote>
<p>（1）创建表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> t_order_rmt<span class="token punctuation">(</span>
 id UInt32<span class="token punctuation">,</span>
 sku_id String<span class="token punctuation">,</span>
 total_amount <span class="token keyword">Decimal</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">,</span>
 create_time <span class="token keyword">Datetime</span> 
<span class="token punctuation">)</span> <span class="token keyword">engine</span> <span class="token operator">=</span>ReplacingMergeTree<span class="token punctuation">(</span>create_time<span class="token punctuation">)</span>
 <span class="token keyword">partition</span> <span class="token keyword">by</span> toYYYYMMDD<span class="token punctuation">(</span>create_time<span class="token punctuation">)</span>
 <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
 <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span> sku_id<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>:warning:注意:</p>
<p>​		ReplacingMergeTree() 填入的参数为版本字段，重复数据保留版本字段值最大的。 如果不填版本字段，默认按照插入顺序保留最后一条。 </p>
<p>（2）向表中插入数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">insert</span> <span class="token keyword">into</span> t_order_rmt <span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token number">101</span><span class="token punctuation">,</span><span class="token string">'sku_001'</span><span class="token punctuation">,</span><span class="token number">1000.00</span><span class="token punctuation">,</span><span class="token string">'2024-01-29 12:00:00'</span><span class="token punctuation">)</span> <span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">102</span><span class="token punctuation">,</span><span class="token string">'sku_002'</span><span class="token punctuation">,</span><span class="token number">2000.00</span><span class="token punctuation">,</span><span class="token string">'2024-01-29 11:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">102</span><span class="token punctuation">,</span><span class="token string">'sku_004'</span><span class="token punctuation">,</span><span class="token number">2500.00</span><span class="token punctuation">,</span><span class="token string">'2024-01-29 12:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">102</span><span class="token punctuation">,</span><span class="token string">'sku_002'</span><span class="token punctuation">,</span><span class="token number">2000.00</span><span class="token punctuation">,</span><span class="token string">'2024-01-29 13:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">102</span><span class="token punctuation">,</span><span class="token string">'sku_002'</span><span class="token punctuation">,</span><span class="token number">12000.00</span><span class="token punctuation">,</span><span class="token string">'2024-01-29 13:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">102</span><span class="token punctuation">,</span><span class="token string">'sku_002'</span><span class="token punctuation">,</span><span class="token number">600.00</span><span class="token punctuation">,</span><span class="token string">'2024-01-29 12:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>（3）执行第一次查询</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t_order_rmt<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202401291731850.png" alt="image-20240129173118745"></p>
<p>（4）手动合并</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">master :<span class="token punctuation">)</span> <span class="token keyword">OPTIMIZE</span> <span class="token keyword">TABLE</span> t_order_rmt FINAL<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>（5）再执行一次查询</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t_order_rmt<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202401291731132.png" alt="image-20240129173127038"></p>
<blockquote>
<p>4）通过测试得到结论</p>
</blockquote>
<pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">➢ 实际上是使用 order by 字段作为唯一键
➢ 去重不能跨分区
➢ 只有同一批插入（新版本）或合并分区时才会进行去重
➢ 认定重复的数据保留，版本字段值最大的
➢ 如果版本字段相同则按插入顺序保留最后一笔<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="4-6-SummingMergeTree"><a href="#4-6-SummingMergeTree" class="headerlink" title="4.6 SummingMergeTree"></a>4.6 SummingMergeTree</h3><p>​		对于不查询明细，只关心以维度进行汇总聚合结果的场景。如果只使用普通的MergeTree 的话，无论是存储空间的开销，还是查询时临时聚合的开销都比较大。</p>
<p>​		ClickHouse 为了这种场景，提供了一种能够“预聚合”的引擎 SummingMergeTree</p>
<blockquote>
<p>1）案例演示</p>
</blockquote>
<p>（1）创建表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> t_order_smt<span class="token punctuation">(</span>
 id UInt32<span class="token punctuation">,</span>
 sku_id String<span class="token punctuation">,</span>
 total_amount <span class="token keyword">Decimal</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">,</span>
 create_time <span class="token keyword">Datetime</span> 
<span class="token punctuation">)</span> <span class="token keyword">engine</span> <span class="token operator">=</span>SummingMergeTree<span class="token punctuation">(</span>total_amount<span class="token punctuation">)</span>
 <span class="token keyword">partition</span> <span class="token keyword">by</span> toYYYYMMDD<span class="token punctuation">(</span>create_time<span class="token punctuation">)</span>
 <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
 <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span>sku_id <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>（2）插入数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">insert</span> <span class="token keyword">into</span> t_order_smt <span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token number">101</span><span class="token punctuation">,</span><span class="token string">'sku_001'</span><span class="token punctuation">,</span><span class="token number">1000.00</span><span class="token punctuation">,</span><span class="token string">'2020-06-01 12:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">102</span><span class="token punctuation">,</span><span class="token string">'sku_002'</span><span class="token punctuation">,</span><span class="token number">2000.00</span><span class="token punctuation">,</span><span class="token string">'2020-06-01 11:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">102</span><span class="token punctuation">,</span><span class="token string">'sku_004'</span><span class="token punctuation">,</span><span class="token number">2500.00</span><span class="token punctuation">,</span><span class="token string">'2020-06-01 12:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">102</span><span class="token punctuation">,</span><span class="token string">'sku_002'</span><span class="token punctuation">,</span><span class="token number">2000.00</span><span class="token punctuation">,</span><span class="token string">'2020-06-01 13:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">102</span><span class="token punctuation">,</span><span class="token string">'sku_002'</span><span class="token punctuation">,</span><span class="token number">12000.00</span><span class="token punctuation">,</span><span class="token string">'2020-06-01 13:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">102</span><span class="token punctuation">,</span><span class="token string">'sku_002'</span><span class="token punctuation">,</span><span class="token number">600.00</span><span class="token punctuation">,</span><span class="token string">'2020-06-02 12:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>（3）执行第一次查询</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">master :<span class="token punctuation">)</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t_order_smt<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202401291759598.png" alt="image-20240129175941509"></p>
<p>（4）手动合并</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">master :<span class="token punctuation">)</span> <span class="token keyword">OPTIMIZE</span> <span class="token keyword">TABLE</span> t_order_smt FINAL<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>（5）再执行一次查询</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">master :<span class="token punctuation">)</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t_order_smt<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202401291759310.png" alt="image-20240129175953202"></p>
<blockquote>
<p>2）通过结果可以得到以下结论</p>
</blockquote>
<pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">➢ 以 SummingMergeTree（）中指定的列作为汇总数据列
➢ 可以填写多列必须数字列，如果不填，以所有非维度列且为数字列的字段为汇总数
据列
➢ 以 order by 的列为准，作为维度列
➢ 其他的列按插入顺序保留第一行
➢ 不在一个分区的数据不会被聚合
➢ 只有在同一批次插入<span class="token punctuation">(</span>新版本<span class="token punctuation">)</span>或分片合并时才会进行聚合<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>3）开发建议</p>
</blockquote>
<p>设计聚合表的话，唯一键值、流水号可以去掉，所有字段全部是维度、度量或者时间戳。</p>
<blockquote>
<p>4）问题</p>
</blockquote>
<p>能不能直接执行以下 SQL 得到汇总值:</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> total_amount <span class="token keyword">from</span> XXX <span class="token keyword">where</span> province_name<span class="token operator">=</span>’’ <span class="token operator">and</span> create_date<span class="token operator">=</span>’xxx’<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>不行，<code>可能会包含一些还没来得及聚合的临时明细</code></p>
<p>​		如果要是获取汇总值，还是需要使用 sum 进行聚合，这样效率会有一定的提高，但本 身 ClickHouse 是列式存储的，效率提升有限，不会特别明显。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token function">sum</span><span class="token punctuation">(</span>total_amount<span class="token punctuation">)</span> <span class="token keyword">from</span> province_name<span class="token operator">=</span>’’ <span class="token operator">and</span> create_date<span class="token operator">=</span>‘xxx’<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h2 id="5-SQL-操作"><a href="#5-SQL-操作" class="headerlink" title="5. SQL 操作"></a>5. SQL 操作</h2><p>​		基本上来说传统关系型数据库（以 MySQL 为例）的 SQL 语句，ClickHouse 基本都支持， 这里不会从头讲解 SQL 语法只介绍 ClickHouse 与标准 SQL（MySQL）不一致的地方。</p>
<h3 id="5-1-Insert"><a href="#5-1-Insert" class="headerlink" title="5.1 Insert"></a>5.1 Insert</h3><p>基本与标准 SQL（MySQL）基本一致:</p>
<p>（1）标准</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token punctuation">[</span>table_name<span class="token punctuation">]</span> <span class="token keyword">values</span><span class="token punctuation">(</span>…<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>…<span class="token punctuation">.</span><span class="token punctuation">)</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>（2）从表到表的插入</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token punctuation">[</span>table_name<span class="token punctuation">]</span> <span class="token keyword">select</span> a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>c <span class="token keyword">from</span> <span class="token punctuation">[</span>table_name_2<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="5-2-Update-和-Delete"><a href="#5-2-Update-和-Delete" class="headerlink" title="5.2 Update 和 Delete"></a>5.2 Update 和 Delete</h3><p>​		ClickHouse 提供了 Delete 和 Update 的能力，这类操作被称为 Mutation 查询，它可以看 做 Alter 的一种。</p>
<p>​		虽然可以实现修改和删除，但是和一般的 OLTP 数据库不一样，<strong>Mutation 语句是一种很 “重”的操作，而且不支持事务。</strong></p>
<p>​		“重”的原因主要是每次修改或者删除都会导致放弃目标数据的原有分区，重建新分区。 所以尽量做批量的变更，不要进行频繁小数据的操作。</p>
<p>（1）删除操作</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">alter</span> <span class="token keyword">table</span> t_order_smt <span class="token keyword">delete</span> <span class="token keyword">where</span> sku_id <span class="token operator">=</span><span class="token string">'sku_001'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>（2）修改操作</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">alter</span> <span class="token keyword">table</span> t_order_smt <span class="token keyword">update</span> total_amount<span class="token operator">=</span>toDecimal32<span class="token punctuation">(</span><span class="token number">2000.00</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">102</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>​		由于操作比较“重”，所以 Mutation 语句分两步执行，同步执行的部分其实只是进行 新增数据新增分区和并把旧分区打上逻辑上的失效标记。<code>直到触发分区合并的时候</code>，<code>才会删 除旧数据释放磁盘空间</code>，一般不会开放这样的功能给用户，由管理员完成。</p>
<h3 id="5-3-查询操作"><a href="#5-3-查询操作" class="headerlink" title="5.3 查询操作"></a>5.3 查询操作</h3><p>ClickHouse 基本上与标准 SQL 差别不大:</p>
<pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">➢ 支持子查询
➢ 支持 CTE<span class="token punctuation">(</span>Common Table Expression 公用表表达式 with 子句<span class="token punctuation">)</span>
➢ 支持各种 JOIN，但是 JOIN 操作无法使用缓存，所以即使是两次相同的 JOIN 语句，ClickHouse 也会视为两条新 SQL
➢ 窗口函数<span class="token punctuation">(</span>官方正在测试中<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
➢ 不支持自定义函数
➢ <span class="token function">GROUP</span> BY 操作增加了 with rollup\with cube\with total 用来计算小计和总计。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>（1）插入数据</p>
<p><code>WHERE 1=1</code> 的条件将匹配表中的所有行，因此执行后将删除整个表中的数据。这种方式不会释放表所占用的磁盘空间，而只是将数据标记为已删除。如果你需要释放磁盘空间，可以考虑使用 <code>OPTIMIZE TABLE</code> 命令。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">master :<span class="token punctuation">)</span> <span class="token keyword">alter</span> <span class="token keyword">table</span> t_order_mt <span class="token keyword">delete</span> <span class="token keyword">where</span> <span class="token number">1</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> t_order_mt <span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token number">101</span><span class="token punctuation">,</span><span class="token string">'sku_001'</span><span class="token punctuation">,</span><span class="token number">1000.00</span><span class="token punctuation">,</span><span class="token string">'2020-06-01 12:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">101</span><span class="token punctuation">,</span><span class="token string">'sku_002'</span><span class="token punctuation">,</span><span class="token number">2000.00</span><span class="token punctuation">,</span><span class="token string">'2020-06-01 12:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">103</span><span class="token punctuation">,</span><span class="token string">'sku_004'</span><span class="token punctuation">,</span><span class="token number">2500.00</span><span class="token punctuation">,</span><span class="token string">'2020-06-01 12:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">104</span><span class="token punctuation">,</span><span class="token string">'sku_002'</span><span class="token punctuation">,</span><span class="token number">2000.00</span><span class="token punctuation">,</span><span class="token string">'2020-06-01 12:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">105</span><span class="token punctuation">,</span><span class="token string">'sku_003'</span><span class="token punctuation">,</span><span class="token number">600.00</span><span class="token punctuation">,</span><span class="token string">'2020-06-02 12:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">106</span><span class="token punctuation">,</span><span class="token string">'sku_001'</span><span class="token punctuation">,</span><span class="token number">1000.00</span><span class="token punctuation">,</span><span class="token string">'2020-06-04 12:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">107</span><span class="token punctuation">,</span><span class="token string">'sku_002'</span><span class="token punctuation">,</span><span class="token number">2000.00</span><span class="token punctuation">,</span><span class="token string">'2020-06-04 12:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">108</span><span class="token punctuation">,</span><span class="token string">'sku_004'</span><span class="token punctuation">,</span><span class="token number">2500.00</span><span class="token punctuation">,</span><span class="token string">'2020-06-04 12:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">109</span><span class="token punctuation">,</span><span class="token string">'sku_002'</span><span class="token punctuation">,</span><span class="token number">2000.00</span><span class="token punctuation">,</span><span class="token string">'2020-06-04 12:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">110</span><span class="token punctuation">,</span><span class="token string">'sku_003'</span><span class="token punctuation">,</span><span class="token number">600.00</span><span class="token punctuation">,</span><span class="token string">'2020-06-01 12:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>（2）with rollup：<code>从右至左去掉维度进行小计</code></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> id <span class="token punctuation">,</span> sku_id<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>total_amount<span class="token punctuation">)</span> <span class="token keyword">from</span> t_order_mt <span class="token keyword">group</span> <span class="token keyword">by</span> id<span class="token punctuation">,</span>sku_id <span class="token keyword">with rollup</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202401291812873.png" alt="image-20240129181236785"></p>
<p>（3）with cube : 从右至左去掉维度进行小计，再从左至右去掉维度进行小计</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> id <span class="token punctuation">,</span> sku_id<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>total_amount<span class="token punctuation">)</span> <span class="token keyword">from</span> t_order_mt <span class="token keyword">group</span> <span class="token keyword">by</span> id<span class="token punctuation">,</span>sku_id <span class="token keyword">with</span> cube<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202401291814767.png" alt="image-20240129181412681"></p>
<p>（4）with totals: 只计算合计</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> id <span class="token punctuation">,</span> sku_id<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>total_amount<span class="token punctuation">)</span> <span class="token keyword">from</span> t_order_mt <span class="token keyword">group</span> <span class="token keyword">by</span> id<span class="token punctuation">,</span>sku_id <span class="token keyword">with</span> totals<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202401291815540.png" alt="image-20240129181501461"></p>
<h3 id="5-4-alter-操作"><a href="#5-4-alter-操作" class="headerlink" title="5.4 alter 操作"></a>5.4 alter 操作</h3><p>同 MySQL 的修改字段基本一致</p>
<blockquote>
<p>1）新增字段</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">alter</span> <span class="token keyword">table</span> tableName <span class="token keyword">add</span> <span class="token keyword">column</span> newcolname String <span class="token keyword">after</span> col1<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<p>2）修改字段类型</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">alter</span> <span class="token keyword">table</span> tableName <span class="token keyword">modify</span> <span class="token keyword">column</span> newcolname String<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<p>3）删除字段</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">alter</span> <span class="token keyword">table</span> tableName <span class="token keyword">drop</span> <span class="token keyword">column</span> newcolname<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="5-5-导出数据-star"><a href="#5-5-导出数据-star" class="headerlink" title="5.5 导出数据 :star:"></a>5.5 导出数据 :star:</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">clickhouse<span class="token operator">-</span>client <span class="token comment">--query "select * from t_order_mt where create_time='2020-06-01 12:00:00'" --format CSVWithNames> /opt/module/data/rs1.csv</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>简写:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">clickhouse-client <span class="token parameter variable">--q</span> <span class="token string">"select * from t_order_mt where create_time='2020-06-01 12:00:00'"</span> <span class="token parameter variable">--format</span> CSVWithNames<span class="token operator">></span> /opt/module/data/rs1.csv<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>更多支持格式参照：</p>
<p><a target="_blank" rel="noopener" href="https://clickhouse.com/docs/en/interfaces/formats">Formats for Input and Output Data | ClickHouse Docs</a></p>
<blockquote>
<p>例子1: 导出students表所有数据</p>
</blockquote>
<p>:one:数据准备:</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 创建学生表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> students <span class="token punctuation">(</span>
    student_id UInt32<span class="token punctuation">,</span>
    name String<span class="token punctuation">,</span>
    age UInt8<span class="token punctuation">,</span>
    grade String
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> MergeTree
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>student_id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 插入示例数据</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> students <span class="token punctuation">(</span>student_id<span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> grade<span class="token punctuation">)</span> <span class="token keyword">VALUES</span>
    <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'Alice'</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'Bob'</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token string">'B'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'Charlie'</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'David'</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token string">'C'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'Eva'</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token string">'B'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">'Frank'</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">'Grace'</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token string">'B'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'Henry'</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token string">'C'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token string">'Ivy'</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">'Jack'</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token string">'B'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token string">'Kelly'</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token string">'C'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token string">'Leo'</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">,</span> <span class="token string">'Mia'</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token string">'B'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">,</span> <span class="token string">'Nina'</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token string">'Oscar'</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token string">'B'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token string">'Peter'</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token string">'C'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">,</span> <span class="token string">'Quinn'</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">,</span> <span class="token string">'Rachel'</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token string">'B'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">,</span> <span class="token string">'Sam'</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token string">'C'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">'Tyler'</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
<span class="token comment">-- 查询所有学生数据</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> students<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>:two:导出students表数据</p>
<p><strong>csv:</strong></p>
<p>写法1:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 导出带表头的csv文件</span>
clickhouse-client <span class="token parameter variable">--port</span> <span class="token number">9001</span> <span class="token parameter variable">--password</span> <span class="token number">123456</span> <span class="token parameter variable">-q</span> <span class="token string">"select * from students;"</span> <span class="token parameter variable">--format</span> CSVWithNames <span class="token operator">></span> /opt/data/stuents.csv
<span class="token comment"># 导出不带表头的csv文件</span>
clickhouse-client <span class="token parameter variable">--port</span> <span class="token number">9001</span> <span class="token parameter variable">--password</span> <span class="token number">123456</span> <span class="token parameter variable">-q</span> <span class="token string">"select * from students;"</span> <span class="token parameter variable">--format</span> CSV <span class="token operator">></span> /opt/data/stuents.csv<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>写法2:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 导出带表头的csv文件</span>
clickhouse-client <span class="token parameter variable">--port</span> <span class="token number">9001</span> <span class="token parameter variable">--password</span> <span class="token number">123456</span> <span class="token parameter variable">-q</span> <span class="token string">"select * from students format CSVWithNames"</span>  <span class="token operator">></span> /opt/data/stuents.csv
<span class="token comment"># 导出不带表头的csv文件</span>
clickhouse-client <span class="token parameter variable">--port</span> <span class="token number">9001</span> <span class="token parameter variable">--password</span> <span class="token number">123456</span> <span class="token parameter variable">-q</span> <span class="token string">"select * from students format CSV"</span>  <span class="token operator">></span> /opt/data/stuents.csv<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>查看导出结果:</p>
<p><img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202401292244205.png" alt="image-20240129224402125"></p>
<h3 id="5-6-导入数据-star"><a href="#5-6-导入数据-star" class="headerlink" title="5.6 导入数据 :star:"></a>5.6 导入数据 :star:</h3><p>:one:清除students表数据做测试</p>
<p>:warning:生产环境禁用</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">TRUNCATE</span> <span class="token keyword">TABLE</span> students<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>:two: 导入&#x2F;opt&#x2F;data&#x2F;stuents.csv文件</p>
<p>写法1:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 导入带表头的csv文件</span>
clickhouse-client <span class="token parameter variable">--password</span> <span class="token number">123456</span> <span class="token parameter variable">--port</span> <span class="token number">9001</span> <span class="token parameter variable">-d</span> default <span class="token parameter variable">-q</span> <span class="token string">" insert into students FORMAT CSVWithNames"</span>  <span class="token operator">&lt;</span>  /opt/data/stuents.csv

<span class="token comment"># 导入不表头的csv文件</span>
clickhouse-client <span class="token parameter variable">--password</span> <span class="token number">123456</span> <span class="token parameter variable">--port</span> <span class="token number">9001</span> <span class="token parameter variable">-d</span> default <span class="token parameter variable">-q</span> <span class="token string">" insert into students FORMAT CSV"</span>  <span class="token operator">&lt;</span>  /opt/data/stuents.csv<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>写法2:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 导入带表头的csv文件</span>
clickhouse-client <span class="token parameter variable">--password</span> <span class="token number">123456</span> <span class="token parameter variable">--port</span> <span class="token number">9001</span> <span class="token parameter variable">-d</span> default <span class="token parameter variable">-q</span> <span class="token string">" insert into students FORMAT CSVWithNames"</span>  <span class="token operator">&lt;</span>  /opt/data/stuents.csv

<span class="token comment"># 导入不表头的csv文件</span>
clickhouse-client <span class="token parameter variable">--password</span> <span class="token number">123456</span> <span class="token parameter variable">--port</span> <span class="token number">9001</span> <span class="token parameter variable">-d</span> default <span class="token parameter variable">-q</span> <span class="token string">" insert into students FORMAT CSV"</span>  <span class="token operator">&lt;</span>  /opt/data/stuents.csv<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>查看导入结果:</p>
<p><img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202401292243915.png" alt="image-20240129224322821"></p>
<h4 id="5-6-1-案例需求1"><a href="#5-6-1-案例需求1" class="headerlink" title="5.6.1 案例需求1:"></a>5.6.1 <strong>案例需求1:</strong></h4><p><strong>需求:</strong></p>
<p>将MySQL某张表的数据导入到clickhouse中</p>
<table>
<thead>
<tr>
<th>数据库</th>
<th>ip</th>
<th>密码</th>
</tr>
</thead>
<tbody><tr>
<td>MySQL(服务器)</td>
<td>192.168.45.13</td>
<td>123456</td>
</tr>
<tr>
<td>clickhouse(本地)</td>
<td>192.168.1.10</td>
<td>123456</td>
</tr>
</tbody></table>
<p><strong>步骤如下:</strong></p>
<blockquote>
<p>:star:导入pom.xml包</p>
</blockquote>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!-- MySQL JDBC Driver --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>5.1.47<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

<span class="token comment">&lt;!-- clickhouse JDBC Driver --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>ru.yandex.clickhouse<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>clickhouse-jdbc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>0.2.6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>:one:导出MySQL 某张表数据,这里以<code>company.staff</code>表做案例</p>
<p>首先查看MySQL表结构,在clickhouse创建一个相同结构的表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">desc</span> company<span class="token punctuation">.</span>staff<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-------+--------------+------+-----+---------+----------------+</span>
<span class="token operator">|</span> Field <span class="token operator">|</span> <span class="token keyword">Type</span>         <span class="token operator">|</span> <span class="token boolean">Null</span> <span class="token operator">|</span> <span class="token keyword">Key</span> <span class="token operator">|</span> <span class="token keyword">Default</span> <span class="token operator">|</span> Extra          <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------+--------------+------+-----+---------+----------------+</span>
<span class="token operator">|</span> id    <span class="token operator">|</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>       <span class="token operator">|</span> <span class="token keyword">NO</span>   <span class="token operator">|</span> PRI <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token keyword">auto_increment</span> <span class="token operator">|</span>
<span class="token operator">|</span> name  <span class="token operator">|</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">|</span> YES  <span class="token operator">|</span>     <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span>                <span class="token operator">|</span>
<span class="token operator">|</span> sex   <span class="token operator">|</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">|</span> YES  <span class="token operator">|</span>     <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span>                <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------+--------------+------+-----+---------+----------------+</span>
<span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>查看该表数据:</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> company<span class="token punctuation">.</span>staff<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+----------+--------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name     <span class="token operator">|</span> sex    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+----------+--------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> Thomas   <span class="token operator">|</span> Male   <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> Catalina <span class="token operator">|</span> FeMale <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+----------+--------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>:two:在clickhouse创建结构相同的表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> gxjzy <span class="token punctuation">(</span>
    id UInt32<span class="token punctuation">,</span>
    name String<span class="token punctuation">,</span>
    sex String
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> MergeTree
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>:three:编写scala代码</p>
<pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>PrintWriter
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span>DriverManager

<span class="token keyword">object</span> ExportMySQLToCSV <span class="token punctuation">&#123;</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// MySQL connection properties MySQL 连接属性</span>
    <span class="token keyword">val</span> mysqlUrl <span class="token operator">=</span> <span class="token string">"jdbc:mysql://master:3306/company"</span>
    <span class="token keyword">val</span> mysqlUser <span class="token operator">=</span> <span class="token string">"root"</span>
    <span class="token keyword">val</span> mysqlPassword <span class="token operator">=</span> <span class="token string">"123456"</span>

    <span class="token comment">// JDBC connection  创建 MySQL 连接,使用 DriverManager 获取 MySQL 连接。</span>
    <span class="token keyword">val</span> mysqlConnection <span class="token operator">=</span> DriverManager<span class="token punctuation">.</span>getConnection<span class="token punctuation">(</span>mysqlUrl<span class="token punctuation">,</span> mysqlUser<span class="token punctuation">,</span> mysqlPassword<span class="token punctuation">)</span>

    <span class="token comment">//尝试执行查询并将结果导出到 CSV：</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// Query to fetch data from MySQL 定义 SQL 查询，选择了 company.staff 表中的所有列。</span>
      <span class="token keyword">val</span> query <span class="token operator">=</span> <span class="token string">"SELECT * FROM company.staff"</span>

      <span class="token comment">// Create a statement and execute the query 创建 Statement 对象并执行查询</span>
      <span class="token keyword">val</span> statement <span class="token operator">=</span> mysqlConnection<span class="token punctuation">.</span>createStatement<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">val</span> resultSet <span class="token operator">=</span> statement<span class="token punctuation">.</span>executeQuery<span class="token punctuation">(</span>query<span class="token punctuation">)</span>

      <span class="token comment">// CSV file path  指定 CSV 文件路径</span>
      <span class="token keyword">val</span> csvFilePath <span class="token operator">=</span> <span class="token string">"/home/gxjzy/桌面/huangjing/company_staff.csv"</span>

      <span class="token comment">// Write data to CSV file 创建 PrintWriter 对象，用于将数据写入文件。</span>
      <span class="token keyword">val</span> writer <span class="token operator">=</span> <span class="token keyword">new</span> PrintWriter<span class="token punctuation">(</span>csvFilePath<span class="token punctuation">)</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>resultSet<span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 根据表列修改此行   遍历查询结果集，将每一行的数据格式化为字符串，写入 CSV 文件。</span>
        <span class="token keyword">val</span> rowData <span class="token operator">=</span> <span class="token string-interpolation"><span class="token id function">s</span><span class="token string">"</span><span class="token interpolation"><span class="token punctuation">$&#123;</span><span class="token expression">resultSet<span class="token punctuation">.</span>getInt<span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span></span><span class="token punctuation">&#125;</span></span><span class="token string">,</span><span class="token interpolation"><span class="token punctuation">$&#123;</span><span class="token expression">resultSet<span class="token punctuation">.</span>getString<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span></span><span class="token punctuation">&#125;</span></span><span class="token string">,</span><span class="token interpolation"><span class="token punctuation">$&#123;</span><span class="token expression">resultSet<span class="token punctuation">.</span>getString<span class="token punctuation">(</span><span class="token string">"sex"</span><span class="token punctuation">)</span></span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>
        writer<span class="token punctuation">.</span>println<span class="token punctuation">(</span>rowData<span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>
      writer<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

      println<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token id function">s</span><span class="token string">"Data exported to CSV file: </span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">csvFilePath</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">case</span> e<span class="token operator">:</span> Exception <span class="token keyword">=></span> e<span class="token punctuation">.</span>printStackTrace<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// Close the MySQL connection 无论是否发生异常，都会在最终块中尝试关闭 MySQL 连接</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>mysqlConnection <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        mysqlConnection<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>运行结果:</p>
<p><img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202401301057346.png" alt="image-20240130105718242"></p>
<p>:four:开始导入数据到clickhouse</p>
<p>(因为使用代码导出数据时,没有设置csv的表头,所以这里使用无表头的方法导入csv文件)</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1.将成功导出的csv文件上传至服务器中</span>
gxjzy@gxjzy:~/桌面/huangjing$ <span class="token function">sudo</span> <span class="token function">docker</span> <span class="token function">cp</span> company_staff.csv dj-master:/root/data
<span class="token comment"># 2.导入不表头的csv文件</span>
<span class="token punctuation">[</span>root@master data<span class="token punctuation">]</span><span class="token comment"># clickhouse-client --port 9001  --password 123456 -d default -q " insert into gxjzy FORMAT CSV" &lt; company_staff.csv</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>登录clickhouse数据库查看数据是否导入成功:</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">master :<span class="token punctuation">)</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> gxjzy<span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> gxjzy

Query id: e0e4b00c<span class="token operator">-</span>b48d<span class="token operator">-</span><span class="token number">4</span>ce4<span class="token operator">-</span>ac16<span class="token operator">-</span><span class="token number">7</span>aec5bc26df4

┌─id─┬─name─────┬─sex────┐
│  <span class="token number">1</span> │ Thomas   │ Male   │
│  <span class="token number">2</span> │ Catalina │ FeMale │
└────┴──────────┴────────┘

<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">.</span> Elapsed: <span class="token number">0.003</span> sec<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>成功如图:<img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202401301105197.png" alt="image-20240130110534109"></p>
<h4 id="5-6-2-比赛需求模拟-star"><a href="#5-6-2-比赛需求模拟-star" class="headerlink" title="5.6.2 比赛需求模拟:star:"></a>5.6.2 比赛需求模拟:star:</h4><p><strong>需求:</strong></p>
<p>将采集到fink采集到的数据 <strong>shtd_result.order_info</strong> 导入到clickhouse中</p>
<p><strong>步骤如下:</strong></p>
<blockquote>
<p>:star:导入pom.xml包</p>
</blockquote>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!-- MySQL JDBC Driver --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>5.1.47<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

<span class="token comment">&lt;!-- clickhouse JDBC Driver --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>ru.yandex.clickhouse<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>clickhouse-jdbc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>0.2.6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>:one:首先查看<strong>shtd_result.order_info</strong>表结构,在clickhouse创建一个<code>相同结构</code>的表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">desc</span> shtd_result<span class="token punctuation">.</span>order_info<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">--------------------+--------------+------+-----+---------+-------+</span>
<span class="token operator">|</span> Field              <span class="token operator">|</span> <span class="token keyword">Type</span>         <span class="token operator">|</span> <span class="token boolean">Null</span> <span class="token operator">|</span> <span class="token keyword">Key</span> <span class="token operator">|</span> <span class="token keyword">Default</span> <span class="token operator">|</span> Extra <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------------+--------------+------+-----+---------+-------+</span>
<span class="token operator">|</span> id                 <span class="token operator">|</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">|</span> YES  <span class="token operator">|</span>     <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span>       <span class="token operator">|</span>
<span class="token operator">|</span> consignee          <span class="token operator">|</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">|</span> YES  <span class="token operator">|</span>     <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span>       <span class="token operator">|</span>
<span class="token operator">|</span> consignee_tel      <span class="token operator">|</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">|</span> YES  <span class="token operator">|</span>     <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span>       <span class="token operator">|</span>
<span class="token operator">|</span> final_total_amount <span class="token operator">|</span> <span class="token keyword">double</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">|</span> YES  <span class="token operator">|</span>     <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span>       <span class="token operator">|</span>
<span class="token operator">|</span> feight_fee         <span class="token operator">|</span> <span class="token keyword">double</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">|</span> YES  <span class="token operator">|</span>     <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span>       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------------+--------------+------+-----+---------+-------+</span>
<span class="token number">5</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>:two:在clickhouse创建结构相同的表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#方式1</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> order_info <span class="token punctuation">(</span>
    id String<span class="token punctuation">,</span>
    consignee String<span class="token punctuation">,</span>
    consignee_tel String<span class="token punctuation">,</span>
    final_total_amount Float64<span class="token punctuation">,</span>
    feight_fee Float64
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> MergeTree<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> id<span class="token punctuation">;</span>

<span class="token comment">#方式2:</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> order_info <span class="token punctuation">(</span>
    id String<span class="token punctuation">,</span>
    consignee String<span class="token punctuation">,</span>
    consignee_tel String<span class="token punctuation">,</span>
    final_total_amount String<span class="token punctuation">,</span>
    feight_fee String
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> MergeTree<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>注意:</strong>	</p>
<p>ClickHouse 中的数据类型与 MySQL 有些许不同，因此在创建表时需要确保字段类型匹配。在这个例子中，<code>varchar(255)</code> 在 ClickHouse 中映射为 <code>String</code>，而 <code>double(10,2)</code> 映射为 <code>Float64</code>。</p>
<p>:three:编写scala代码</p>
<pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>PrintWriter
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span>DriverManager

<span class="token keyword">object</span> MySQLToClickHouse <span class="token punctuation">&#123;</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// MySQL connection properties MySQL 连接属性</span>
    <span class="token keyword">val</span> mysqlUrl <span class="token operator">=</span> <span class="token string">"jdbc:mysql://192.168.45.13:3306/shtd_result"</span>
    <span class="token keyword">val</span> mysqlUser <span class="token operator">=</span> <span class="token string">"root"</span>
    <span class="token keyword">val</span> mysqlPassword <span class="token operator">=</span> <span class="token string">"123456"</span>

    <span class="token comment">// JDBC connection  创建 MySQL 连接,使用 DriverManager 获取 MySQL 连接。</span>
    <span class="token keyword">val</span> mysqlConnection <span class="token operator">=</span> DriverManager<span class="token punctuation">.</span>getConnection<span class="token punctuation">(</span>mysqlUrl<span class="token punctuation">,</span> mysqlUser<span class="token punctuation">,</span> mysqlPassword<span class="token punctuation">)</span>

    <span class="token comment">//尝试执行查询并将结果导出到 CSV：</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// Query to fetch data from MySQL 定义 SQL 查询，选择了 company.staff 表中的所有列。</span>
      <span class="token keyword">val</span> query <span class="token operator">=</span> <span class="token string">"SELECT * FROM shtd_result.order_info"</span>

      <span class="token comment">// Create a statement and execute the query 创建 Statement 对象并执行查询</span>
      <span class="token keyword">val</span> statement <span class="token operator">=</span> mysqlConnection<span class="token punctuation">.</span>createStatement<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">val</span> resultSet <span class="token operator">=</span> statement<span class="token punctuation">.</span>executeQuery<span class="token punctuation">(</span>query<span class="token punctuation">)</span>

      <span class="token comment">// CSV file path  指定 CSV 文件路径</span>
      <span class="token keyword">val</span> csvFilePath <span class="token operator">=</span> <span class="token string">"/home/gxjzy/桌面/shtd_result.order_info.csv"</span>

      <span class="token comment">// Write data to CSV file 创建 PrintWriter 对象，用于将数据写入文件。</span>
      <span class="token keyword">val</span> writer <span class="token operator">=</span> <span class="token keyword">new</span> PrintWriter<span class="token punctuation">(</span>csvFilePath<span class="token punctuation">)</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>resultSet<span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 根据表列修改此行   遍历查询结果集，将每一行的数据格式化为字符串，写入 CSV 文件。</span>
        <span class="token comment">// val rowData = s"$&#123;resultSet.getInt("id")&#125;,$&#123;resultSet.getString("name")&#125;,$&#123;resultSet.getString("sex")&#125;"</span>
        <span class="token keyword">val</span> rowData <span class="token operator">=</span> <span class="token string-interpolation"><span class="token id function">s</span><span class="token string">"</span><span class="token interpolation"><span class="token punctuation">$&#123;</span><span class="token expression">resultSet<span class="token punctuation">.</span>getString<span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span></span><span class="token punctuation">&#125;</span></span><span class="token string">,</span><span class="token interpolation"><span class="token punctuation">$&#123;</span><span class="token expression">resultSet<span class="token punctuation">.</span>getString<span class="token punctuation">(</span><span class="token string">"consignee"</span><span class="token punctuation">)</span></span><span class="token punctuation">&#125;</span></span><span class="token string">,</span><span class="token interpolation"><span class="token punctuation">$&#123;</span><span class="token expression">resultSet<span class="token punctuation">.</span>getString<span class="token punctuation">(</span><span class="token string">"consignee_tel"</span><span class="token punctuation">)</span></span><span class="token punctuation">&#125;</span></span><span class="token string">,</span><span class="token interpolation"><span class="token punctuation">$&#123;</span><span class="token expression">resultSet<span class="token punctuation">.</span>getString<span class="token punctuation">(</span><span class="token string">"final_total_amount"</span><span class="token punctuation">)</span></span><span class="token punctuation">&#125;</span></span><span class="token string">,</span><span class="token interpolation"><span class="token punctuation">$&#123;</span><span class="token expression">resultSet<span class="token punctuation">.</span>getString<span class="token punctuation">(</span><span class="token string">"feight_fee"</span><span class="token punctuation">)</span></span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>
        writer<span class="token punctuation">.</span>println<span class="token punctuation">(</span>rowData<span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>
      writer<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

      println<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token id function">s</span><span class="token string">"Data exported to CSV file: </span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">csvFilePath</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">case</span> e<span class="token operator">:</span> Exception <span class="token keyword">=></span> e<span class="token punctuation">.</span>printStackTrace<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// Close the MySQL connection 无论是否发生异常，都会在最终块中尝试关闭 MySQL 连接</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>mysqlConnection <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        mysqlConnection<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>运行结果:</p>
<p><img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202401301517323.png" alt="image-20240130151735218"></p>
<p>:four:开始导入数据到clickhouse</p>
<p>(因为使用代码导出数据时,没有设置csv的表头,所以这里使用无表头的方法导入csv文件)</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1.将成功导出的csv文件上传至服务器中</span>
gxjzy@gxjzy:~/桌面/sql_CSV$ <span class="token function">sudo</span> <span class="token function">docker</span> <span class="token function">cp</span> shtd_result.order_info.csv dj-master:/root/data
<span class="token comment"># 2.导入不表头的csv文件</span>
<span class="token punctuation">[</span>root@master data<span class="token punctuation">]</span><span class="token comment"># clickhouse-client --port 9001  --password 123456 -d default -q " insert into order_info FORMAT CSV" &lt; shtd_result.order_info.csv</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>登录clickhouse数据库查看数据是否导入成功:</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">master :<span class="token punctuation">)</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> order_info<span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> order_info

Query id: b816d87c<span class="token operator">-</span><span class="token number">478</span>a<span class="token operator">-</span><span class="token number">4</span>f58<span class="token operator">-</span><span class="token number">8</span>ae4<span class="token operator">-</span><span class="token number">9</span>bec876dfa34

┌─id───┬─consignee─┬─consignee_tel─┬─final_total_amount─┬─feight_fee─┐
│ <span class="token number">3570</span> │ 狄兴良    │ <span class="token number">13948905139</span>   │ <span class="token number">451.00</span>             │ <span class="token number">7.00</span>       │
│ <span class="token number">3571</span> │ 岑坚      │ <span class="token number">13220439586</span>   │ <span class="token number">682.00</span>             │ <span class="token number">16.00</span>      │
│ <span class="token number">3572</span> │ 贺兰凤    │ <span class="token number">13022309909</span>   │ <span class="token number">285.00</span>             │ <span class="token number">10.00</span>      │
│ <span class="token number">3573</span> │ 邬艺咏    │ <span class="token number">13752952612</span>   │ <span class="token number">6673.00</span>            │ <span class="token number">13.00</span>      │
│ <span class="token number">3574</span> │ 宋春      │ <span class="token number">13901511343</span>   │ <span class="token number">14691.00</span>           │ <span class="token number">8.00</span>       │
│ <span class="token number">3575</span> │ 史晨辰    │ <span class="token number">13146190655</span>   │ <span class="token number">4339.00</span>            │ <span class="token number">13.00</span>      │
│ <span class="token number">3576</span> │ 邬素      │ <span class="token number">13661734372</span>   │ <span class="token number">4270.00</span>            │ <span class="token number">12.00</span>      │
│ <span class="token number">3577</span> │ 姜奇      │ <span class="token number">13060645675</span>   │ <span class="token number">468.00</span>             │ <span class="token number">9.00</span>       │
│ <span class="token number">3578</span> │ 张娣      │ <span class="token number">13586813843</span>   │ <span class="token number">26718.00</span>           │ <span class="token number">18.00</span>      │
└──────┴───────────┴───────────────┴────────────────────┴────────────┘

<span class="token number">9</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">.</span> Elapsed: <span class="token number">0.005</span> sec<span class="token punctuation">.</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>结果:<img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202401301528146.png" alt="image-20240130152811062"></p>
<p>完成</p>
<h2 id="6-clickhouse的使用"><a href="#6-clickhouse的使用" class="headerlink" title="6. clickhouse的使用"></a>6. clickhouse的使用</h2><h3 id="6-1-在ClickHouse中创建表"><a href="#6-1-在ClickHouse中创建表" class="headerlink" title="6.1  在ClickHouse中创建表"></a>6.1  在ClickHouse中创建表</h3><p>与大多数数据库管理系统一样，ClickHouse 按逻辑将表分组到<strong>数据库</strong>中。使用<code>CREATE DATABASE</code>命令在ClickHouse中创建新数据库：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> helloworld<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202309241309281.png" alt="image-20230825140404003"></p>
<p>同样，使用<code>CREATE TABLE</code>来定义一个新表。（如果不指定数据库名称，则该表将在 <code>default</code>数据库中。）以下名为的表<code>my_first_table</code>在数据库中<code>helloworld</code>：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> helloworld<span class="token punctuation">.</span>my_first_table<span class="token punctuation">(</span>user_id UInt32<span class="token punctuation">,</span>message String<span class="token punctuation">,</span><span class="token keyword">timestamp</span> <span class="token keyword">DateTime</span><span class="token punctuation">,</span>metric Float32<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> MergeTree<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> <span class="token keyword">timestamp</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202309241309931.png" alt="image-20230825140621498"></p>
<p>在上面的示例中，<code>my_first_table</code>是一个<code>MergeTree</code>包含四列的表：</p>
<p>1、<code>user_id</code>: 32 位无符号整数</p>
<p>2、<code>message</code>：一种<code>String</code>数据类型，它替换其他数据库系统中的<code>VARCHAR</code>、<code>BLOB</code>、<code>CLOB</code>等类型</p>
<p>3、<code>timestamp</code>: 一个<code>DateTime</code>值，代表时间的一个瞬间</p>
<p>4、<code>metric</code>：32位浮点数</p>
<p>表结构：<img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202309241309537.png" alt="image-20230825140809783"></p>
<p>笔记</p>
<p>表引擎确定：</p>
<p>1、数据的存储方式和位置</p>
<p>2、支持哪些查询</p>
<p>3、数据是否被复制</p>
<p>有许多引擎可供选择，但对于单节点 ClickHouse 服务器上的简单表，<a target="_blank" rel="noopener" href="https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/mergetree">MergeTree</a>可能是您的选择。</p>
<blockquote>
<p>主键</p>
</blockquote>
<p>在继续之前，了解主键在 ClickHouse 中的工作原理非常重要（主键的实现可能看起来出乎意料！）：</p>
<ul>
<li>ClickHouse 中的主键对于表中的每一行来说<font color='red'>不是唯一的</font></li>
</ul>
<p>ClickHouse 表的主键决定了数据写入磁盘时的排序方式。每 8,192 行或 10MB 数据（称为<strong>索引粒度</strong>）在主键索引文件中创建一个条目。这种粒度概念创建了一个可以轻松放入内存的<strong>稀疏索引</strong><code>SELECT</code>，并且颗粒表示查询期间处理的最小列数据量的条带。</p>
<p>主键可以使用<code>PRIMARY KEY</code>参数定义。如果定义表时未<code>PRIMARY KEY</code>指定，则键将成为<code>ORDER BY</code>子句中指定的元组。如果您同时指定 a<code>PRIMARY KEY </code>和 an <code>ORDER BY</code>，则主键必须是排序顺序的子集。</p>
<p>主键也是排序键，它是 的元组<code>(user_id, timestamp)</code>。因此，每个列文件中存储的数据将按<code>user_id</code>，然后排序<code>timestamp</code>。</p>
<p>#创建表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">data</span> :<span class="token punctuation">)</span> <span class="token keyword">create</span> <span class="token keyword">TABLE</span> my_first_table <span class="token punctuation">(</span> user_id UInt32<span class="token punctuation">,</span>message String<span class="token punctuation">,</span><span class="token keyword">timestamp</span> <span class="token keyword">DateTime</span><span class="token punctuation">,</span>metric Float32<span class="token punctuation">)</span><span class="token keyword">ENGINE</span> <span class="token operator">=</span> MergeTree <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> <span class="token keyword">timestamp</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>结果：<img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202309241309304.png" alt="image-20230825093650584"></p>
<h3 id="6-2-将数据插入-ClickHouse"><a href="#6-2-将数据插入-ClickHouse" class="headerlink" title="6.2 将数据插入 ClickHouse:)"></a>6.2 将数据插入 ClickHouse:)</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">huangjing :<span class="token punctuation">)</span>  <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> my_first_table <span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> message<span class="token punctuation">,</span> <span class="token keyword">timestamp</span><span class="token punctuation">,</span> metric<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">101</span><span class="token punctuation">,</span> <span class="token string">'Hello, ClickHouse!'</span><span class="token punctuation">,</span>              <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">102</span><span class="token punctuation">,</span> <span class="token string">'Insert a lot of rows per batch'</span><span class="token punctuation">,</span>            yesterday<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1.41421</span> <span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">102</span><span class="token punctuation">,</span> <span class="token string">'Sort your data based on your commonly-used queries'</span><span class="token punctuation">,</span> today<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2.718</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">101</span><span class="token punctuation">,</span> <span class="token string">'Granules are the smallest chunks of data read'</span><span class="token punctuation">,</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">,</span><span class="token number">3.14159</span> <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>结果：<img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202309241309828.png" alt="image-20230825093935032"></p>
<p>#查看插入的数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">data</span> :<span class="token punctuation">)</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> my_first_table<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>结果：<img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202309241309151.png" alt="image-20230825094025963"></p>
<h3 id="6-3-ClickHouse-中的-SELECT-查询"><a href="#6-3-ClickHouse-中的-SELECT-查询" class="headerlink" title="6.3  ClickHouse 中的 SELECT 查询"></a>6.3  ClickHouse 中的 SELECT 查询</h3><p><code>SELECT</code>ClickHouse 是一个 SQL 数据库，您可以通过编写您已经熟悉的相同类型的查询来查询数据。例如：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> helloworld<span class="token punctuation">.</span>my_first_table <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token keyword">timestamp</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>响应以良好的表格格式返回：</p>
<p><img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202309241309948.png" alt="image-20230825142026059"></p>
<p>添加一个子句来指定<a target="_blank" rel="noopener" href="https://clickhouse.com/docs/en/interfaces/formats">ClickHouse 支持的多种输出格式</a><code>FORMAT</code>之一：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> helloworld<span class="token punctuation">.</span>my_first_table <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token keyword">timestamp</span> FORMAT TabSeparated<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>在上面的查询中，输出以制表符分隔的形式返回：</p>
<p><img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202309241310857.png" alt="image-20230825142212843"></p>
<h3 id="6-4-更新数据"><a href="#6-4-更新数据" class="headerlink" title="6.4 更新数据"></a>6.4 更新数据</h3><p>使用以下<code>ALTER TABLE...UPDATE</code>命令更新表中的行：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token punctuation">[</span><span class="token operator">&lt;</span><span class="token keyword">database</span><span class="token operator">></span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token keyword">table</span><span class="token operator">></span> <span class="token keyword">UPDATE</span> <span class="token operator">&lt;</span><span class="token keyword">column</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token operator">&lt;</span>expression<span class="token operator">></span> <span class="token keyword">WHERE</span> <span class="token operator">&lt;</span>filter_expr<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<p><code>&lt;expression&gt;</code>是满足 的列的新值<code>&lt;filter_expr&gt;</code>。必须<code>&lt;expression&gt;</code>与列具有相同的数据类型，或者可以使用<code>CAST</code>运算符转换为相同的数据类型。应该为每行数据<code>&lt;filter_expr&gt;</code>返回一个<code>UInt8</code>（零或非零）值。多个<code>UPDATE &lt;column&gt;</code>语句可以组合在一个<code>ALTER TABLE</code>命令中，并用逗号分隔。</p>
<p><strong>例子</strong>：</p>
<ol>
<li><p>更新数据，将userid为101的内容改成huangjing</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> helloworld<span class="token punctuation">.</span>my_first_table <span class="token keyword">UPDATE</span> message <span class="token operator">=</span> <span class="token string">'huangjing'</span> <span class="token keyword">WHERE</span> user_id<span class="token operator">=</span><span class="token string">'101'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>结果：<img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202309241310570.png" alt="image-20230825143022048"></p>
</li>
<li><p>更新排序键列</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> helloworld<span class="token punctuation">.</span>my_first_table <span class="token keyword">UPDATE</span> user_id<span class="token operator">=</span><span class="token string">'110'</span> <span class="token keyword">WHERE</span> message <span class="token operator">=</span> <span class="token string">'huangjing'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>结果（发现并没有更新）：<img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202309241310974.png" alt="image-20230825143322671"></p>
</li>
</ol>
<p>无法更新属于主键或排序键的列。</p>
<h3 id="6-5-删除数据"><a href="#6-5-删除数据" class="headerlink" title="6.5 删除数据"></a>6.5 删除数据</h3><p>使用<code>ALTER TABLE</code>命令删除行：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token punctuation">[</span><span class="token operator">&lt;</span><span class="token keyword">database</span><span class="token operator">></span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token keyword">table</span><span class="token operator">></span> <span class="token keyword">DELETE</span> <span class="token keyword">WHERE</span> <span class="token operator">&lt;</span>filter_expr<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<p>应该<code>&lt;filter_expr&gt;</code>为每行数据返回一个 UInt8 值。</p>
<p><strong>例子</strong></p>
<ol>
<li><p>删除metric中的-1的值：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> helloworld<span class="token punctuation">.</span>my_first_table <span class="token keyword">DELETE</span> <span class="token keyword">WHERE</span> metric<span class="token operator">=</span><span class="token string">'-1'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>结果：<img src="https://hj-typora-images-1319512400.cos.ap-guangzhou.myqcloud.com/images/202309241310296.png" alt="image-20230825143613961"></p>
</li>
</ol>
<p>要删除表中的所有数据，使用command<code>TRUNCATE TABLE [&lt;database].]&lt;table&gt;</code>命令效率更高。这个命令也可以执行<code>ON CLUSTER</code>。</p>
<p>查看<a target="_blank" rel="noopener" href="https://clickhouse.com/docs/en/sql-reference/statements/delete"><code>DELETE</code>声明</a>文档页面了解更多详细信息。</p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">無以菱</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://www.wylblog.cn/2024/11/13/clickhouse-dan-ji-bu-shu-pei-zhi-shi-yong-21-9-4-35/">https://www.wylblog.cn/2024/11/13/clickhouse-dan-ji-bu-shu-pei-zhi-shi-yong-21-9-4-35/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">無以菱</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Bigdata/">
                                    <span class="chip bg-color">Bigdata</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="https://img.picui.cn/free/2024/11/10/67306dc163e90.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="https://img.picui.cn/free/2024/11/10/67306da5565ae.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments textarea {
        box-sizing: border-box;
        background: url("/medias/comment_bg.png") 100% 100% no-repeat;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #4cbf30;
        font-weight: 500;
        text-decoration: none;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="vcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: 'Mte7fae2id8Jx9bKn48B0kdJ-gzGzoHsz',
        appKey: 'RW87hMrhzc4zeYx3QkqSsIGr',
        serverURLs: 'https://Mte7fae2.lc-cn-n1-shared.com',
        notify: 'false' === 'true',
        verify: 'false' === 'true',
        visitor: 'true' === 'true',
        avatar: 'mm',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: 'just go go'
    });
</script>

<!--酷Q推送-->


    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="far fa-dot-circle"></i>&nbsp;本篇
            </div>
            <div class="card">
                <a href="/2024/11/13/clickhouse-dan-ji-bu-shu-pei-zhi-shi-yong-21-9-4-35/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/8.jpg" class="responsive-img" alt="ClickHouse单机部署配置使用(21.9.4.35)">
                        
                        <span class="card-title">ClickHouse单机部署配置使用(21.9.4.35)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2024-11-13
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE%E8%BF%90%E7%BB%B4%E7%B3%BB%E5%88%97/" class="post-category">
                                    大数据运维系列
                                </a>
                            
                            <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE%E8%BF%90%E7%BB%B4%E7%B3%BB%E5%88%97/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B3%BB%E5%88%97/" class="post-category">
                                    数据库系列
                                </a>
                            
                            
                        </span>
                    </div>
                </div>

                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Bigdata/">
                        <span class="chip bg-color">Bigdata</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2024/11/13/hadoop-wei-fen-bu-shi-bu-shu/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/7.jpg" class="responsive-img" alt="Hadoop伪分布式部署">
                        
                        <span class="card-title">Hadoop伪分布式部署</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2024-11-13
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE%E8%BF%90%E7%BB%B4%E7%B3%BB%E5%88%97/" class="post-category">
                                    大数据运维系列
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Bigdata/">
                        <span class="chip bg-color">Bigdata</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('200')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE' || selection.getRangeAt(0).commonAncestorContainer.nodeName === 'CODE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: 無以菱<br />'
            + '文章作者: 無以菱<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.min.js"></script>


<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2024</span>
            
            <a href="/about" target="_blank">無以菱</a>
            <!-- |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a> -->
            |&nbsp;每天进步一点点&nbsp;<a href="/about" target="_blank">(=ＴェＴ=)挨骂</a>
            |&nbsp;永远支持&nbsp;<a href="https://m.weibo.cn/u/3179885602" target="_blank">ZCY</a>
            
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">50.1k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
                <span id="sitetime"> Loading ...</span>
                <script>
                    var calcSiteTime = function () {
                        var seconds = 1000;
                        var minutes = seconds * 60;
                        var hours = minutes * 60;
                        var days = hours * 24;
                        var years = days * 365;
                        var today = new Date();
                        var startYear = "2024";
                        var startMonth = "10";
                        var startDate = "13";
                        var startHour = "0";
                        var startMinute = "0";
                        var startSecond = "0";
                        var todayYear = today.getFullYear();
                        var todayMonth = today.getMonth() + 1;
                        var todayDate = today.getDate();
                        var todayHour = today.getHours();
                        var todayMinute = today.getMinutes();
                        var todaySecond = today.getSeconds();
                        var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                        var diff = t2 - t1;
                        var diffYears = Math.floor(diff / years);
                        var diffDays = Math.floor((diff / days) - diffYears * 365);

                        // 区分是否有年份.
                        var language = 'zh-CN';
                        if (startYear === String(todayYear)) {
                            document.getElementById("year").innerHTML = todayYear;
                            var daysTip = 'This site has been running for ' + diffDays + ' days';
                            if (language === 'zh-CN') {
                                daysTip = '本站已运行 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                daysTip = '本站已運行 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = daysTip;
                        } else {
                            document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                            var yearsAndDaysTip = 'This site has been running for ' + diffYears + ' years and '
                                + diffDays + ' days';
                            if (language === 'zh-CN') {
                                yearsAndDaysTip = '本站已运行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                yearsAndDaysTip = '本站已運行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = yearsAndDaysTip;
                        }
                    }

                    calcSiteTime();
                </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/wylblog" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:2794998160@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2794998160" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 2794998160" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>



    <a href="https://m.weibo.cn/u/3179885602" class="tooltipped" target="_blank" data-tooltip="关注我的微博: https://m.weibo.cn/u/3179885602" data-position="top" data-delay="50">
        <i class="fab fa-weibo"></i>
    </a>





</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>
    <!-- 添加强大的板娘 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css">
    <script src="https://cdn.jsdelivr.net/gh/17lai/live2d-widget@latest/autoload.js"></script>
    <!-- 添加完成 -->

    

    
    
    
        
        <script type="text/javascript">
            // 只在桌面版网页启用特效
            var windowWidth = $(window).width();
            if (windowWidth > 768) {
                document.write('<script type="text/javascript" src="/libs/others/sakura.js"><\/script>');
            }
        </script>
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    
    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon-refresh.min.js" async="async"></script>
    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
